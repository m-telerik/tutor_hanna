<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/student.css">
</head>
<body>
  <div class="page-content">
    <div class="header">
      <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
      <h1><span class="emoji">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞</h1>
      <div></div>
    </div>

    <div class="page-layout">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ -->
      <div class="left-column">
        <div class="student-header">
          <h2><span class="emoji">üë§</span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        </div>
        
        <div id="student-info">
          <div class="loading-state">
            <span class="loading-spinner"></span>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
          </div>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ª–æ–≤–∞—Ä—å -->
      <div class="right-column">
        <div class="vocab-header">
          <h2><span class="emoji">üìö</span>–°–ª–æ–≤–∞—Ä—å</h2>
          <div class="vocab-count" id="vocab-count">0 —Å–ª–æ–≤</div>
        </div>
        
        <div id="vocabulary-content">
          <div class="loading-state">
            <span class="loading-spinner"></span>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤–∞—Ä—è...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- –§—É—Ç–µ—Ä -->
    <div class="footer">
      –ü—Ä–æ–±–ª–µ–º—ã? –í–æ–ø—Ä–æ—Å—ã? –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è? 
      <a href="https://t.me/tutor_hanna_bot" target="_blank">–ù–∞–ø–∏—à–∏ –•–∞–Ω–Ω–∞ –±–æ—Ç—É</a> 
      –∏ –æ–Ω –ø–µ—Ä–µ–¥–∞—Å—Ç —Ç–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∞–¥—Ä–µ—Å—É
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const studentName = urlParams.get("name");
    
    // –ü–æ–ª—É—á–∞–µ–º userId
    let userId = null;
    try {
      userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    } catch (error) {
      console.log('Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
    }
    
    if (!userId) {
      userId = 618647337; // –¢–µ—Å—Ç–æ–≤—ã–π ID –∞–¥–º–∏–Ω–∞
    }
    
    let studentData = null;

    if (!studentName) {
      document.getElementById('student-info').innerHTML = `
        <div class="error-state">
          <h3>–û—à–∏–±–∫–∞</h3>
          <p>–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞</p>
        </div>
      `;
    } else {
      loadStudentInfo();
      loadVocabulary();
    }

    async function loadStudentInfo() {
      try {
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId.toString() }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const { students } = await response.json();
        const student = students.find(s => s.name === studentName);

        if (!student) {
          throw new Error('–°—Ç—É–¥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        studentData = student;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.title = `–ü—Ä–æ—Ñ–∏–ª—å: ${student.name}`;
        document.querySelector('h1').innerHTML = `<span class="emoji">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å: ${student.name}`;

        // –†–µ–∂–∏–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        const bookingMode = student.booking_mode === 'by_student' 
          ? 'üìÖ –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ' 
          : 'üéì –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º';

        const bookingClass = student.booking_mode === 'by_student' ? 'by-student' : 'by-teacher';

        // –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è (–ø–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–µ–µ)
        const lessonsHtml = student.next_session ? `
          <a href="lesson.html?session_id=${student.next_session_id}" class="lesson-item">
            <div class="lesson-date">${student.next_session}</div>
            <div class="lesson-language">${student.language}</div>
          </a>
        ` : `
          <div class="no-lessons">
            –ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π
          </div>
        `;

        // –†–µ–Ω–¥–µ—Ä–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        document.getElementById('student-info').innerHTML = `
          <ul class="info-list">
            <li class="info-item">
              <span class="info-label">–ò–º—è:</span>
              <span class="info-value">${student.name}</span>
            </li>
            
            ${student.email ? `
              <li class="info-item">
                <span class="info-label">Email:</span>
                <span class="info-value">${student.email}</span>
              </li>
            ` : ''}
            
            ${student.username ? `
              <li class="info-item">
                <span class="info-label">Telegram:</span>
                <span class="info-value">
                  <a href="https://t.me/${student.username}" target="_blank" style="color: var(--accent-color);">
                    @${student.username}
                  </a>
                </span>
              </li>
            ` : ''}
            
            <li class="info-item">
              <span class="info-label">–Ø–∑—ã–∫:</span>
              <span class="info-value">
                <span class="language-badge">${student.language || '‚Äî'}</span>
              </span>
            </li>
            
            <li class="info-item">
              <span class="info-label">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</span>
              <span class="info-value">
                <span class="booking-badge ${bookingClass}">${bookingMode}</span>
              </span>
            </li>
            
            ${student.frequency ? `
              <li class="info-item">
                <span class="info-label">–ß–∞—Å—Ç–æ—Ç–∞:</span>
                <span class="info-value">${student.frequency}x –≤ –Ω–µ–¥–µ–ª—é</span>
              </li>
            ` : ''}
            
            ${student.preferred_time ? `
              <li class="info-item">
                <span class="info-label">–í—Ä–µ–º—è:</span>
                <span class="info-value">${student.preferred_time}</span>
              </li>
            ` : ''}
            
            ${student.preferred_days && student.preferred_days.length > 0 ? `
              <li class="info-item">
                <span class="info-label">–î–Ω–∏:</span>
                <span class="info-value">${student.preferred_days.join(', ')}</span>
              </li>
            ` : ''}
          </ul>

          <div class="lessons-section">
            <h3><span class="emoji">üìÖ</span>–ó–∞–Ω—è—Ç–∏—è</h3>
            <div class="lessons-list" id="lessons-list">
              ${lessonsHtml}
            </div>
          </div>

          <button class="book-button" onclick="openBooking()">
            <span class="emoji">üìÖ</span>
            –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ
          </button>
        `;

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞:', error);
        document.getElementById('student-info').innerHTML = `
          <div class="error-state">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>${error.message}</p>
            <button onclick="loadStudentInfo()" class="btn-primary" style="margin-top: 1rem;">
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    async function loadVocabulary() {
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π API —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
        const response = await fetch(`/api/vocab?user_name=${encodeURIComponent(studentName)}`, {
          headers: { "x-telegram-id": userId.toString() }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const { words = [] } = await response.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        document.getElementById('vocab-count').textContent = `${words.length} —Å–ª–æ–≤`;

        if (words.length === 0) {
          document.getElementById('vocabulary-content').innerHTML = `
            <div class="empty-vocab">
              <span class="emoji">üìö</span>
              <p>–°–ª–æ–≤–∞—Ä—å –ø–æ–∫–∞ –ø—É—Å—Ç</p>
              <p style="font-size: 11px; opacity: 0.7;">–°–ª–æ–≤–∞ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –ø–æ—Å–ª–µ —É—Ä–æ–∫–æ–≤</p>
            </div>
          `;
          return;
        }

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —è–∑—ã–∫–∞–º –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const englishWords = words.filter(w => w.language === 'english').length;
        const frenchWords = words.filter(w => w.language === 'french').length;
        const studiedWords = words.filter(w => w.studied_count > 0).length;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å –¥–µ—Ç–∞–ª—è–º–∏
        document.getElementById('vocab-count').innerHTML = `
          ${words.length} —Å–ª–æ–≤
          ${englishWords > 0 || frenchWords > 0 ? `<br><small style="opacity: 0.8; font-size: 10px;">
            ${englishWords > 0 ? `EN: ${englishWords}` : ''}
            ${englishWords > 0 && frenchWords > 0 ? ' ‚Ä¢ ' : ''}
            ${frenchWords > 0 ? `FR: ${frenchWords}` : ''}
          </small>` : ''}
        `;

        // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É —Å–ª–æ–≤–∞—Ä—è
        document.getElementById('vocabulary-content').innerHTML = `
          <table class="vocab-table">
            <thead>
              <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–°–ª–æ–≤–æ</th>
                <th>–ü–µ—Ä–µ–≤–æ–¥</th>
                <th>–ü—Ä–∏–º–µ—Ä</th>
              </tr>
            </thead>
            <tbody>
              ${words.map(word => `
                <tr>
                  <td class="date-cell">
                    ${word.created_at ? new Date(word.created_at).toLocaleDateString('ru-RU', {
                      day: '2-digit',
                      month: '2-digit'
                    }) : '‚Äî'}
                  </td>
                  <td class="word-cell">
                    ${word.word}
                    ${word.language ? `<br><small style="color: var(--accent-color); font-size: 9px; opacity: 0.8;">${word.language.toUpperCase()}</small>` : ''}
                  </td>
                  <td class="translation-cell">${word.translation || '‚Äî'}</td>
                  <td class="example-cell" title="${word.example || ''}">${word.example || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è:', error);
        document.getElementById('vocabulary-content').innerHTML = `
          <div class="error-state">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è</h3>
            <p>${error.message}</p>
            <button onclick="loadVocabulary()" class="btn-primary" style="margin-top: 1rem;">
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    function openBooking() {
      const bookingUrl = 'https://calendar.app.google/SQGJj626MUyQ6DYL6';
      
      if (window.Telegram?.WebApp?.openLink) {
        window.Telegram.WebApp.openLink(bookingUrl);
      } else {
        window.open(bookingUrl, '_blank');
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    if (window.Telegram?.WebApp) {
      try {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      } catch (error) {
        console.log('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
      }
    }

    console.log('Student profile –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è:', studentName);
  </script>
</body>
</html>
