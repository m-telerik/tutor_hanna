<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/chat-history.css">
</head>
<body>
  <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="header">
    <h1><span class="emoji">üí¨</span>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h1>
    
    <div class="navigation-panel">
      <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä –∞–≥–µ–Ω—Ç–∞ -->
      <div class="step">
        <div class="step-label">1. –í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞:</div>
        <div class="step-controls">
          <select id="agentSelect" onchange="onAgentChange()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞...</option>
            <option value="hanna_user">ü§ñ TutorBot (–æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç)</option>
            <option value="student">üë§ Student Agent (–¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)</option>
            <option value="lead">üåü Lead Agent (–¥–ª—è –ª–∏–¥–æ–≤)</option>
          </select>
        </div>
      </div>

      <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –¥–∞—Ç—ã (–¥–ª—è TutorBot) –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
      <div class="step" id="step2" style="display: none;">
        <div class="step-label" id="step2Label"></div>
        <div class="step-controls">
          <input type="date" id="dateSelect" disabled onchange="onDateChange()" />
          <select id="filterSelect" onchange="onFilterChange()" disabled style="display: none;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
          </select>
          <button class="load-btn" onclick="loadChatData()" disabled id="loadDataBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats" id="stats" style="display: none;"></div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ –ø–∞–º—è—Ç–∏ -->
  <div id="memoryKeyInfo" style="display: none;"></div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
  <div class="data-table" id="dataTable" style="display: none;">
    <table>
      <thead>
        <tr>
          <th>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
          <th>Agent</th>
          <th>Type</th>
          <th>Content</th>
          <th>–í—Ä–µ–º—è</th>
        </tr>
      </thead>
      <tbody id="dataTableBody">
      </tbody>
    </table>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ -->
  <div id="statusContainer">
    <div class="loading">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
      <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
        <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã:</strong><br>
        ‚Ä¢ ü§ñ TutorBot - –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
        ‚Ä¢ üë§ Student Agent - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤<br>
        ‚Ä¢ üåü Lead Agent - –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
      </div>
    </div>
  </div>

  <script>
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 618647337;
    let currentAgent = '';
    let allMessages = [];
    let availableStudents = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateSelect').value = today;
      
      loadAvailableStudents();
    });

    async function loadAvailableStudents() {
      try {
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId }
        });
        
        if (response.ok) {
          const { students } = await response.json();
          availableStudents = students;
        }
      } catch (error) {
        console.error('Error loading students:', error);
      }
    }

    function onAgentChange() {
      const agentSelect = document.getElementById('agentSelect');
      const step2 = document.getElementById('step2');
      const step2Label = document.getElementById('step2Label');
      const dateSelect = document.getElementById('dateSelect');
      const filterSelect = document.getElementById('filterSelect');
      const loadDataBtn = document.getElementById('loadDataBtn');
      
      // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
      resetInterface();
      
      currentAgent = agentSelect.value;
      
      if (!currentAgent) {
        step2.style.display = 'none';
        return;
      }

      step2.style.display = 'block';

      if (currentAgent === 'hanna_user') {
        // –î–ª—è TutorBot –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–∞—Ç—ã
        step2Label.textContent = '2. –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:';
        dateSelect.style.display = 'block';
        filterSelect.style.display = 'none';
        dateSelect.disabled = false;
        loadDataBtn.disabled = false;
        
      } else if (currentAgent === 'student') {
        // –î–ª—è Student Agent –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        step2Label.textContent = '2. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞:';
        dateSelect.style.display = 'none';
        filterSelect.style.display = 'block';
        populateStudentFilter();
        
      } else if (currentAgent === 'lead') {
        // –î–ª—è Lead Agent –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –ª–∏–¥–æ–≤
        step2Label.textContent = '2. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –ª–∏–¥–∞:';
        dateSelect.style.display = 'none';
        filterSelect.style.display = 'block';
        populateLeadStatusFilter();
      }
    }

    function populateStudentFilter() {
      const filterSelect = document.getElementById('filterSelect');
      const loadDataBtn = document.getElementById('loadDataBtn');
      
      filterSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞...</option>';
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã
      availableStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.name.toLowerCase().replace(/\s+/g, '');
        option.textContent = student.name;
        option.dataset.telegramId = student.telegram_id || '';
        filterSelect.appendChild(option);
      });
      
      filterSelect.disabled = false;
      loadDataBtn.disabled = true;
    }

    function populateLeadStatusFilter() {
      const filterSelect = document.getElementById('filterSelect');
      const loadDataBtn = document.getElementById('loadDataBtn');
      
      filterSelect.innerHTML = `
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...</option>
        <option value="new">üÜï –ù–æ–≤—ã–µ –ª–∏–¥—ã</option>
        <option value="contacted">üìû –°–≤—è–∑–∞–ª–∏—Å—å</option>
        <option value="interested">üí´ –ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã</option>
        <option value="trial">üéØ –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫</option>
        <option value="converted">‚úÖ –°—Ç–∞–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</option>
        <option value="lost">‚ùå –ü–æ—Ç–µ—Ä—è–Ω—ã</option>
        <option value="all">üìã –í—Å–µ –ª–∏–¥—ã</option>
      `;
      
      filterSelect.disabled = false;
      loadDataBtn.disabled = true;
    }

    function onDateChange() {
      // –î–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞, –º–æ–∂–µ–º –∑–∞–≥—Ä—É–∂–∞—Ç—å
      const loadDataBtn = document.getElementById('loadDataBtn');
      loadDataBtn.disabled = false;
    }

    function onFilterChange() {
      const filterSelect = document.getElementById('filterSelect');
      const loadDataBtn = document.getElementById('loadDataBtn');
      
      loadDataBtn.disabled = !filterSelect.value;
    }

    async function loadChatData() {
      const statusContainer = document.getElementById('statusContainer');
      const dataTable = document.getElementById('dataTable');
      const stats = document.getElementById('stats');
      const memoryKeyInfo = document.getElementById('memoryKeyInfo');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      statusContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞...</div>';
      dataTable.style.display = 'none';
      stats.style.display = 'none';
      memoryKeyInfo.style.display = 'none';

      try {
        let memoryKey = '';
        let userData = {};

        if (currentAgent === 'hanna_user') {
          // –î–ª—è TutorBot —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á —Å –¥–∞—Ç–æ–π
          const selectedDate = document.getElementById('dateSelect').value;
          memoryKey = `hanna_user_${userId}_${selectedDate}`;
          userData = { name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', agent: 'TutorBot' };
          
        } else if (currentAgent === 'student') {
          const selectedStudent = document.getElementById('filterSelect').value;
          memoryKey = `student_${selectedStudent}`;
          const student = availableStudents.find(s => s.name.toLowerCase().replace(/\s+/g, '') === selectedStudent);
          userData = { name: student?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç', agent: 'Student Agent' };
          
        } else if (currentAgent === 'lead') {
          const selectedStatus = document.getElementById('filterSelect').value;
          // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–π –ª–∏–¥
          memoryKey = `lead_937619983`;
          userData = { name: '–ö—Å–µ–Ω–∏—è', agent: 'Lead Agent' };
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const response = await fetch(`/api/chat-history?memory_key=${encodeURIComponent(memoryKey)}`, {
          headers: { "x-telegram-id": userId }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const { messages } = await response.json();
        
        if (!messages || messages.length === 0) {
          statusContainer.innerHTML = '<div class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</div>';
          return;
        }
        
        allMessages = messages;
        renderDataTable(userData);
        updateStats();
        showMemoryKeyInfo(memoryKey, userData);
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        statusContainer.style.display = 'none';
        dataTable.style.display = 'block';
        stats.style.display = 'flex';
        memoryKeyInfo.style.display = 'block';
        
      } catch (error) {
        console.error('Error loading chat data:', error);
        statusContainer.innerHTML = `
          <div class="error">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞: ${error.message}</p>
            <button onclick="loadChatData()" style="margin-top: 1rem; background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    function renderDataTable(userData) {
      const tbody = document.getElementById('dataTableBody');
      
      tbody.innerHTML = allMessages.map(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          const timestamp = msg.created_at ? new Date(msg.created_at).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          
          return `
            <tr>
              <td>
                <div class="user-name">${userData.name}</div>
                <small style="opacity: 0.6;">ID: ${msg.id}</small>
              </td>
              <td>
                <span class="agent-badge">${userData.agent}</span>
              </td>
              <td>
                <span class="type-badge ${parsed.type}">${getTypeEmoji(parsed.type)} ${parsed.type}</span>
              </td>
              <td class="content-cell">${escapeHtml(parsed.content || '–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ')}</td>
              <td>
                <small>${timestamp}</small>
              </td>
            </tr>
          `;
        } catch (error) {
          return `
            <tr>
              <td>${userData.name}</td>
              <td><span class="agent-badge error">ERROR</span></td>
              <td><span class="type-badge system">‚ö†Ô∏è error</span></td>
              <td class="content-cell">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${escapeHtml(msg.message)}</td>
              <td><small>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</small></td>
            </tr>
          `;
        }
      }).join('');
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const typeCounts = { ai: 0, human: 0, system: 0, error: 0 };
      
      allMessages.forEach(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          typeCounts[parsed.type] = (typeCounts[parsed.type] || 0) + 1;
        } catch {
          typeCounts.error++;
        }
      });
      
      stats.innerHTML = `
        <span>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${allMessages.length}</span>
        <span>AI: ${typeCounts.ai}</span>
        <span>Human: ${typeCounts.human}</span>
        <span>System: ${typeCounts.system}</span>
        ${typeCounts.error > 0 ? `<span>–û—à–∏–±–∫–∏: ${typeCounts.error}</span>` : ''}
      `;
    }

    function showMemoryKeyInfo(memoryKey, userData) {
      const memoryKeyInfo = document.getElementById('memoryKeyInfo');
      
      memoryKeyInfo.innerHTML = `
        <div class="memory-key-info">
          <span><strong>–ö–ª—é—á –ø–∞–º—è—Ç–∏:</strong> <code style="background: var(--bg-color); padding: 2px 6px; border-radius: 4px; font-family: monospace;">${memoryKey}</code></span>
          <span><strong>–ê–≥–µ–Ω—Ç:</strong> ${userData.agent}</span>
          <span><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${userData.name}</span>
        </div>
      `;
    }

    function resetInterface() {
      allMessages = [];
      
      document.getElementById('dataTable').style.display = 'none';
      document.getElementById('stats').style.display = 'none';
      document.getElementById('memoryKeyInfo').style.display = 'none';
      document.getElementById('loadDataBtn').disabled = true;
      
      document.getElementById('statusContainer').innerHTML = `
        <div class="loading">
          <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
            <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã:</strong><br>
            ‚Ä¢ ü§ñ TutorBot - –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
            ‚Ä¢ üë§ Student Agent - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤<br>
            ‚Ä¢ üåü Lead Agent - –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
          </div>
        </div>
      `;
      document.getElementById('statusContainer').style.display = 'block';
    }

    function getTypeEmoji(type) {
      const emojis = {
        ai: 'ü§ñ',
        human: 'üë§', 
        system: '‚öôÔ∏è',
        assistant: 'ü§ñ',
        user: 'üë§'
      };
      return emojis[type] || '‚ùì';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
