<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–∞–Ω–µ–ª—å —Ç—å—é—Ç–æ—Ä–∞ - Hanna English & French</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/navigation.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/tutor.css">
  <link rel="stylesheet" href="styles/navigation.css">
</head>
<body>
  <div class="container role-tutor">
    <!-- –•–µ–¥–µ—Ä —Ç—å—é—Ç–æ—Ä–∞ -->
    <div class="tutor-header">
      <h1><span class="emoji">üë©‚Äçüè´</span>–ü–∞–Ω–µ–ª—å —Ç—å—é—Ç–æ—Ä–∞</h1>
      <div class="tutor-info" id="tutorInfo">
        –ó–∞–≥—Ä—É–∑–∫–∞...
      </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div id="navigation-container"></div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentTutor = null;
    let navigation = null;
    let auth = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ —Ç—å—é—Ç–æ—Ä–∞...');
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram WebApp
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      
      try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        auth = new AuthSystem();
        const user = await auth.init(['tutor', 'admin'], onAuthSuccess, onAuthFail);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
      }
    });

    // –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    function onAuthSuccess(user) {
      console.log('‚úÖ –¢—å—é—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user);
      
      currentTutor = user;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—å—é—Ç–æ—Ä–µ
      updateTutorInfo(user);
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
      initializeNavigation(user);
    }

    // –ù–µ—É–¥–∞—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    function onAuthFail(error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ç—å—é—Ç–æ—Ä–∞:', error);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—å—é—Ç–æ—Ä–µ
    function updateTutorInfo(user) {
      const tutorInfo = document.getElementById('tutorInfo');
      if (tutorInfo) {
        tutorInfo.innerHTML = `
          ${user.name} ‚Ä¢ ${user.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–¢—å—é—Ç–æ—Ä'}
        `;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function initializeNavigation(user) {
      // –°–æ–∑–¥–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
      navigation = initNavigation(user, 'navigation-container');
      
      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è —Å–º–µ–Ω—ã —Å–µ–∫—Ü–∏–∏
      document.addEventListener('navigation:sectionChange', handleSectionChange);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–µ—Ä–≤–æ–π —Å–µ–∫—Ü–∏–∏
      setTimeout(() => {
        const currentSection = navigation.getCurrentSection();
        loadSectionContent(currentSection);
      }, 100);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Å–µ–∫—Ü–∏–∏
    function handleSectionChange(event) {
      const { sectionId } = event.detail;
      console.log('üìç –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–µ–∫—Ü–∏—é:', sectionId);
      
      loadSectionContent(sectionId);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–µ–∫—Ü–∏–∏
    async function loadSectionContent(sectionId) {
      console.log('üìö –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å–µ–∫—Ü–∏–∏:', sectionId);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      navigation.setSectionLoading(sectionId, true);
      
      try {
        let content = '';
        
        switch (sectionId) {
          case 'dashboard':
            content = await loadDashboardContent();
            break;
          case 'students':
            content = await loadStudentsContent();
            break;
          case 'schedule':
            content = await loadScheduleContent();
            break;
          case 'recurring':
            content = await loadRecurringContent();
            break;
          case 'materials':
            content = await loadMaterialsContent();
            break;
          case 'analytics':
            content = await loadAnalyticsContent();
            break;
          default:
            content = `<div class="empty-state">
              <div class="placeholder-icon">üöß</div>
              <h3>–°–µ–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h3>
              <p>–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–µ–∫—Ü–∏–∏ "${sectionId}" –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ</p>
            </div>`;
        }
        
        navigation.updateSectionContent(sectionId, content);
        
      } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–∏ ${sectionId}:`, error);
        navigation.setSectionError(sectionId, error.message);
      }
    }

    // ===== –ó–ê–ì–†–£–ó–ß–ò–ö–ò –ö–û–ù–¢–ï–ù–¢–ê –°–ï–ö–¶–ò–ô =====

    async function loadDashboardContent() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—å—é—Ç–æ—Ä–∞
      const stats = await loadTutorStats();
      
      return `
        <div class="dashboard-content">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">${stats.students}</div>
              <div class="stat-label">–ú–æ–∏ —Å—Ç—É–¥–µ–Ω—Ç—ã</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${stats.todayLessons}</div>
              <div class="stat-label">–°–µ–≥–æ–¥–Ω—è —É—Ä–æ–∫–æ–≤</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${stats.weekLessons}</div>
              <div class="stat-label">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${stats.recurringSchedules}</div>
              <div class="stat-label">–†–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π</div>
            </div>
          </div>
          
          <div class="quick-actions">
            <button class="action-card" onclick="createNewLesson()">
              <span class="emoji">‚ûï</span>
              <div class="title">–ù–æ–≤—ã–π —É—Ä–æ–∫</div>
              <div class="subtitle">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ</div>
            </button>
            <button class="action-card" onclick="navigation.switchToSection('students')">
              <span class="emoji">üë•</span>
              <div class="title">–°—Ç—É–¥–µ–Ω—Ç—ã</div>
              <div class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏</div>
            </button>
            <button class="action-card" onclick="navigation.switchToSection('schedule')">
              <span class="emoji">üìÖ</span>
              <div class="title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
              <div class="subtitle">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤</div>
            </button>
          </div>
          
          <div class="upcoming-lessons">
            <h3>–ë–ª–∏–∂–∞–π—à–∏–µ —É—Ä–æ–∫–∏</h3>
            <div id="upcoming-lessons-list">
              ${renderUpcomingLessons(stats.upcomingLessons || [])}
            </div>
          </div>
        </div>
      `;
    }

    async function loadStudentsContent() {
      const response = await auth.apiRequest('/api/students');
      const { students } = await response.json();
      
      return `
        <div class="students-content">
          <div class="section-header">
            <h3>–ú–æ–∏ —Å—Ç—É–¥–µ–Ω—Ç—ã</h3>
            <div class="section-actions">
              <button class="btn-primary" onclick="addNewStudent()">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞
              </button>
              <button class="btn-secondary" onclick="loadSectionContent('students')">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
              </button>
            </div>
          </div>
          
          <div class="students-grid">
            ${students.map(student => `
              <div class="student-card">
                <div class="student-header">
                  <div class="student-name">${student.name}</div>
                  ${student.username ? `<div class="student-username">@${student.username}</div>` : ''}
                </div>
                
                <div class="student-info">
                  <div class="info-row">
                    <span class="label">–Ø–∑—ã–∫:</span>
                    <span class="value">${student.language || '‚Äî'}</span>
                  </div>
                  <div class="info-row">
                    <span class="label">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫:</span>
                    <span class="value">${student.next_session || '–ù–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω'}</span>
                  </div>
                  <div class="info-row">
                    <span class="label">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</span>
                    <span class="value">${student.booking_mode === 'by_student' ? '–°—Ç—É–¥–µ–Ω—Ç–æ–º' : '–¢—å—é—Ç–æ—Ä–æ–º'}</span>
                  </div>
                </div>
                
                <div class="student-actions">
                  <button class="action-btn primary" onclick="scheduleLesson('${student.id}')">
                    üìÖ –£—Ä–æ–∫
                  </button>
                  <button class="action-btn secondary" onclick="viewStudentProgress('${student.id}')">
                    üìä –ü—Ä–æ–≥—Ä–µ—Å—Å
                  </button>
                  <button class="action-btn secondary" onclick="openChat('${student.username}')">
                    üí¨ –ß–∞—Ç
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    async function loadScheduleContent() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ —É—Ä–æ–∫–∏
      const lessons = await loadUpcomingLessons();
      
      return `
        <div class="schedule-content">
          <div class="section-header">
            <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤</h3>
            <div class="section-actions">
              <select id="scheduleFilter" onchange="filterSchedule()">
                <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                <option value="tomorrow">–ó–∞–≤—Ç—Ä–∞</option>
                <option value="week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
                <option value="month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
              </select>
              <button class="btn-primary" onclick="createNewLesson()">
                ‚ûï –ù–æ–≤—ã–π —É—Ä–æ–∫
              </button>
            </div>
          </div>
          
          <div class="schedule-view">
            ${lessons.length === 0 ? `
              <div class="empty-state">
                <div class="placeholder-icon">üìÖ</div>
                <h3>–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —É—Ä–æ–∫ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</p>
                <button class="btn-primary" onclick="createNewLesson()">
                  ‚ûï –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫
                </button>
              </div>
            ` : `
              <div class="lessons-timeline">
                ${lessons.map(lesson => `
                  <div class="lesson-item ${lesson.status}">
                    <div class="lesson-time">
                      <div class="time">${lesson.time}</div>
                      <div class="date">${lesson.date}</div>
                    </div>
                    <div class="lesson-details">
                      <div class="lesson-title">${lesson.studentName}</div>
                      <div class="lesson-meta">
                        ${lesson.language} ‚Ä¢ ${lesson.duration} –º–∏–Ω ‚Ä¢ ${lesson.type}
                      </div>
                      ${lesson.notes ? `<div class="lesson-notes">${lesson.notes}</div>` : ''}
                    </div>
                    <div class="lesson-actions">
                      ${lesson.zoomLink ? `
                        <button class="action-btn primary" onclick="joinLesson('${lesson.zoomLink}')">
                          üé• Zoom
                        </button>
                      ` : ''}
                      <button class="action-btn secondary" onclick="editLesson('${lesson.id}')">
                        ‚úèÔ∏è
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    async function loadRecurringContent() {
      const response = await auth.apiRequest('/api/recurring-schedules');
      const { schedules } = await response.json();
      
      return `
        <div class="recurring-content">
          <div class="section-header">
            <h3>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>
            <div class="section-actions">
              <button class="btn-primary" onclick="createRecurringSchedule()">
                ‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
              </button>
              <button class="btn-secondary" onclick="loadSectionContent('recurring')">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
              </button>
            </div>
          </div>
          
          ${schedules.length === 0 ? `
            <div class="empty-state">
              <div class="placeholder-icon">üîÑ</div>
              <h3>–ù–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π</h3>
              <p>–°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–∫–æ–≤</p>
              <button class="btn-primary" onclick="createRecurringSchedule()">
                ‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
              </button>
            </div>
          ` : `
            <div class="recurring-grid">
              ${renderRecurringSchedules(schedules)}
            </div>
          `}
        </div>
      `;
    }

    async function loadMaterialsContent() {
      return `
        <div class="materials-content">
          <div class="section-header">
            <h3>–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
            <div class="section-actions">
              <button class="btn-primary" onclick="uploadMaterial()">
                ‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å
              </button>
              <button class="btn-secondary" onclick="createMaterial()">
                ‚ûï –°–æ–∑–¥–∞—Ç—å
              </button>
            </div>
          </div>
          
          <div class="materials-grid">
            <div class="material-category">
              <h4>üìö –£—á–µ–±–Ω–∏–∫–∏</h4>
              <div class="material-list">
                <div class="material-item">
                  <div class="material-icon">üìñ</div>
                  <div class="material-info">
                    <div class="material-name">English Grammar in Use</div>
                    <div class="material-meta">PDF ‚Ä¢ 15 MB</div>
                  </div>
                  <button class="action-btn">üì§</button>
                </div>
              </div>
            </div>
            
            <div class="material-category">
              <h4>üéµ –ê—É–¥–∏–æ</h4>
              <div class="material-list">
                <div class="material-item">
                  <div class="material-icon">üéß</div>
                  <div class="material-info">
                    <div class="material-name">Pronunciation Practice</div>
                    <div class="material-meta">MP3 ‚Ä¢ 8 MB</div>
                  </div>
                  <button class="action-btn">‚ñ∂Ô∏è</button>
                </div>
              </div>
            </div>
            
            <div class="material-category">
              <h4>üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h4>
              <div class="material-list">
                <div class="material-item">
                  <div class="material-icon">‚úèÔ∏è</div>
                  <div class="material-info">
                    <div class="material-name">Past Simple Exercises</div>
                    <div class="material-meta">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
                  </div>
                  <button class="action-btn">üéØ</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadAnalyticsContent() {
      const analytics = await loadAnalyticsData();
      
      return `
        <div class="analytics-content">
          <div class="section-header">
            <h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã</h3>
            <div class="section-actions">
              <select id="analyticsFilter">
                <option value="week">–ù–µ–¥–µ–ª—è</option>
                <option value="month">–ú–µ—Å—è—Ü</option>
                <option value="quarter">–ö–≤–∞—Ä—Ç–∞–ª</option>
              </select>
              <button class="btn-secondary" onclick="exportReport()">
                üìä –≠–∫—Å–ø–æ—Ä—Ç
              </button>
            </div>
          </div>
          
          <div class="analytics-grid">
            <div class="analytics-card">
              <h4>üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
              <div class="analytics-stats">
                <div class="stat-item">
                  <span class="stat-number">${analytics.totalLessons}</span>
                  <span class="stat-label">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —É—Ä–æ–∫–æ–≤</span>
                </div>
                <div class="stat-item">
                  <span class="stat-number">${analytics.totalHours}</span>
                  <span class="stat-label">–ß–∞—Å–æ–≤ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è</span>
                </div>
                <div class="stat-item">
                  <span class="stat-number">${analytics.activeStudents}</span>
                  <span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</span>
                </div>
              </div>
            </div>
            
            <div class="analytics-card">
              <h4>üìä –ü—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h4>
              <div class="progress-list">
                ${analytics.studentProgress.map(student => `
                  <div class="progress-item">
                    <div class="student-name">${student.name}</div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${student.progress}%"></div>
                    </div>
                    <div class="progress-text">${student.progress}%</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="analytics-card">
              <h4>‚è∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h4>
              <div class="time-chart">
                ${renderTimeChart(analytics.timeActivity)}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====

    async function loadTutorStats() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å —Å–µ—Ä–≤–µ—Ä–∞
        const [studentsRes, lessonsRes, recurringRes] = await Promise.all([
          auth.apiRequest('/api/students'),
          auth.apiRequest('/api/student-lessons?status=upcoming&limit=10'),
          auth.apiRequest('/api/recurring-schedules')
        ]);
        
        const { students } = await studentsRes.json();
        const { lessons } = await lessonsRes.json();
        const { schedules } = await recurringRes.json();
        
        const today = new Date();
        const todayLessons = lessons.filter(l => {
          const lessonDate = new Date(l.session_datetime);
          return lessonDate.toDateString() === today.toDateString();
        });
        
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay());
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 7);
        
        const weekLessons = lessons.filter(l => {
          const lessonDate = new Date(l.session_datetime);
          return lessonDate >= weekStart && lessonDate < weekEnd;
        });
        
        return {
          students: students.length,
          todayLessons: todayLessons.length,
          weekLessons: weekLessons.length,
          recurringSchedules: schedules.filter(s => s.is_active).length,
          upcomingLessons: lessons.slice(0, 5)
        };
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        return {
          students: 0,
          todayLessons: 0,
          weekLessons: 0,
          recurringSchedules: 0,
          upcomingLessons: []
        };
      }
    }

    function renderUpcomingLessons(lessons) {
      if (lessons.length === 0) {
        return `
          <div class="empty-state">
            <p>–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</p>
          </div>
        `;
      }
      
      return lessons.map(lesson => `
        <div class="lesson-preview">
          <div class="lesson-time">
            ${new Date(lesson.session_datetime).toLocaleString('ru-RU')}
          </div>
          <div class="lesson-student">${lesson.student_name}</div>
          <div class="lesson-language">${lesson.language}</div>
        </div>
      `).join('');
    }

    function renderRecurringSchedules(schedules) {
      const groupedByDay = {};
      schedules.forEach(schedule => {
        const day = schedule.day_of_week;
        if (!groupedByDay[day]) groupedByDay[day] = [];
        groupedByDay[day].push(schedule);
      });
      
      const dayNames = {
        1: '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', 2: '–í—Ç–æ—Ä–Ω–∏–∫', 3: '–°—Ä–µ–¥–∞', 4: '–ß–µ—Ç–≤–µ—Ä–≥',
        5: '–ü—è—Ç–Ω–∏—Ü–∞', 6: '–°—É–±–±–æ—Ç–∞', 7: '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
      };
      
      return Object.entries(groupedByDay).map(([day, daySchedules]) => `
        <div class="day-column">
          <h4 class="day-header">${dayNames[day]}</h4>
          <div class="day-schedules">
            ${daySchedules.map(schedule => `
              <div class="schedule-card ${schedule.is_active ? 'active' : 'inactive'}">
                <div class="schedule-time">${schedule.time_start}</div>
                <div class="schedule-name">${schedule.name}</div>
                <div class="schedule-participants">
                  ${schedule.participant_names?.join(', ') || '‚Äî'}
                </div>
                <div class="schedule-actions">
                  <button class="action-btn" onclick="editSchedule('${schedule.id}')">‚úèÔ∏è</button>
                  <button class="action-btn" onclick="toggleSchedule('${schedule.id}')">
                    ${schedule.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    async function loadUpcomingLessons() {
      // –ú–æ–∫ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
      return [
        {
          id: 1,
          time: '10:00',
          date: '–°–µ–≥–æ–¥–Ω—è',
          studentName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
          language: 'English',
          duration: 60,
          type: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π',
          status: 'confirmed',
          zoomLink: 'https://zoom.us/j/123456789'
        },
        {
          id: 2,
          time: '15:00',
          date: '–ó–∞–≤—Ç—Ä–∞',
          studentName: '–ú–∏—Ö–∞–∏–ª –ò–≤–∞–Ω–æ–≤',
          language: 'French',
          duration: 45,
          type: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π',
          status: 'planned'
        }
      ];
    }

    async function loadAnalyticsData() {
      return {
        totalLessons: 127,
        totalHours: 95,
        activeStudents: 12,
        studentProgress: [
          { name: '–ê–Ω–Ω–∞', progress: 85 },
          { name: '–ú–∏—Ö–∞–∏–ª', progress: 72 },
          { name: '–ï–ª–µ–Ω–∞', progress: 91 }
        ],
        timeActivity: [
          { hour: '9:00', lessons: 3 },
          { hour: '10:00', lessons: 5 },
          { hour: '11:00', lessons: 7 },
          { hour: '14:00', lessons: 4 },
          { hour: '15:00', lessons: 6 },
          { hour: '16:00', lessons: 8 }
        ]
      };
    }

    function renderTimeChart(timeData) {
      const maxLessons = Math.max(...timeData.map(d => d.lessons));
      
      return `
        <div class="chart-bars">
          ${timeData.map(item => `
            <div class="chart-bar">
              <div class="bar" style="height: ${(item.lessons / maxLessons) * 100}%"></div>
              <div class="bar-label">${item.hour}</div>
              <div class="bar-value">${item.lessons}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–ï–ô–°–¢–í–ò–ô =====

    function createNewLesson() {
      showNotification('üîß –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    function addNewStudent() {
      showNotification('üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    function scheduleLesson(studentId) {
      showNotification(`üîß –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ${studentId} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
    }

    function viewStudentProgress(studentId) {
      showNotification(`üîß –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ ${studentId} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
    }

    function openChat(username) {
      if (username) {
        window.open(`https://t.me/${username}`, '_blank');
      } else {
        showNotification('–£ —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–µ—Ç Telegram username', 'warning');
      }
    }

    function createRecurringSchedule() {
      showNotification('üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    function editSchedule(scheduleId) {
      showNotification(`üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ${scheduleId} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
    }

    function toggleSchedule(scheduleId) {
      showNotification(`üîß –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ${scheduleId} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
    }

    function joinLesson(zoomLink) {
      window.open(zoomLink, '_blank');
    }

    function editLesson(lessonId) {
      showNotification(`üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞ ${lessonId} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
    }

    function filterSchedule() {
      const filter = document.getElementById('scheduleFilter').value;
      showNotification(`üîß –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: ${filter}`, 'info');
    }

    function uploadMaterial() {
      showNotification('üîß –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    function createMaterial() {
      showNotification('üîß –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    function exportReport() {
      showNotification('üîß –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success-color)' :
                     type === 'error' ? 'var(--error-color)' :
                     type === 'warning' ? '#ff9800' : 'var(--accent-color)'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-width: 300px;
        font-size: 13px;
        animation: slideInRight 0.3s ease-out;
        line-height: 1.4;
      `;

      if (!document.getElementById('notificationStyles')) {
        const style = document.createElement('style');
        style.id = 'notificationStyles';
        style.textContent = `
          @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }

      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        if (document.body.contains(notification)) {
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }
      }, 3000);
    }

    console.log('‚úÖ –ü–∞–Ω–µ–ª—å —Ç—å—é—Ç–æ—Ä–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
  </script>
</body>
</html>