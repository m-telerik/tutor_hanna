<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/chat-history.css">
</head>
<body>
  <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="header">
    <h1><span class="emoji">üí¨</span>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h1>
    
    <div class="navigation-panel">
      <div class="step">
        <div class="step-label">–í—ã–±–µ—Ä–∏—Ç–µ Telegram ID:</div>
        <div class="step-controls">
          <select id="telegramIdSelect" onchange="onTelegramIdChange()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ Telegram ID...</option>
          </select>
          <button class="load-btn" onclick="loadChatData()" disabled id="loadDataBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats" id="stats" style="display: none;"></div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
  <div id="userInfo" style="display: none;"></div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
  <div class="data-table" id="dataTable" style="display: none;">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Session ID</th>
          <th>Type</th>
          <th>Content</th>
        </tr>
      </thead>
      <tbody id="dataTableBody">
      </tbody>
    </table>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ -->
  <div id="statusContainer">
    <div class="loading">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ Telegram ID –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤</p>
      <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
        <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</strong><br>
        ‚Ä¢ üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>
        ‚Ä¢ üîç –ê–Ω–∞–ª–∏–∑ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –∞–≥–µ–Ω—Ç–∞–º–∏<br>
        ‚Ä¢ üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Å–æ–æ–±—â–µ–Ω–∏–π
      </div>
    </div>
  </div>

  <script>
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 618647337;
    let allMessages = [];
    let availableUsers = [];
    let selectedTelegramId = '';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      
      loadAvailableUsers();
    });

    async function loadAvailableUsers() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è telegram_id
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId }
        });
        
        if (response.ok) {
          const { students } = await response.json();
          availableUsers = students.filter(s => s.username); // –¢–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å username
          populateTelegramIdSelect();
        }
      } catch (error) {
        console.error('Error loading users:', error);
        populateTelegramIdSelect(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π select —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
      }
    }

    function populateTelegramIdSelect() {
      const select = document.getElementById('telegramIdSelect');
      
      // –û—á–∏—â–∞–µ–º select
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ Telegram ID...</option>';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      availableUsers.forEach(user => {
        if (user.username) {
          const option = document.createElement('option');
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º username –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –Ω–µ—Ç telegram_id –≤ API
          option.value = user.username;
          option.textContent = `${user.name} (@${user.username})`;
          select.appendChild(option);
        }
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
      const manualOption = document.createElement('option');
      manualOption.value = 'manual';
      manualOption.textContent = '‚ûï –í–≤–µ—Å—Ç–∏ ID –≤—Ä—É—á–Ω—É—é';
      select.appendChild(manualOption);
    }

    function onTelegramIdChange() {
      const select = document.getElementById('telegramIdSelect');
      const loadBtn = document.getElementById('loadDataBtn');
      
      if (select.value === 'manual') {
        // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        const manualInput = document.createElement('input');
        manualInput.type = 'text';
        manualInput.id = 'manualTelegramId';
        manualInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ Telegram ID...';
        manualInput.style.marginLeft = '10px';
        manualInput.style.padding = '6px 10px';
        manualInput.style.border = '1px solid var(--border-color)';
        manualInput.style.borderRadius = '4px';
        
        manualInput.addEventListener('input', function() {
          selectedTelegramId = this.value.trim();
          loadBtn.disabled = !selectedTelegramId;
        });
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ select
        select.parentNode.insertBefore(manualInput, loadBtn);
        loadBtn.disabled = true;
        
      } else {
        // –£–¥–∞–ª—è–µ–º –ø–æ–ª–µ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const existingInput = document.getElementById('manualTelegramId');
        if (existingInput) {
          existingInput.remove();
        }
        
        selectedTelegramId = select.value;
        loadBtn.disabled = !selectedTelegramId;
      }
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      resetInterface();
    }

    async function loadChatData() {
      const statusContainer = document.getElementById('statusContainer');
      const dataTable = document.getElementById('dataTable');
      const stats = document.getElementById('stats');
      const userInfo = document.getElementById('userInfo');
      
      if (!selectedTelegramId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ Telegram ID');
        return;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      statusContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤...</div>';
      dataTable.style.display = 'none';
      stats.style.display = 'none';
      userInfo.style.display = 'none';

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API chat-history —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ telegram_id
        const response = await fetch(`/api/chat-history?telegram_id=${encodeURIComponent(selectedTelegramId)}`, {
          headers: { "x-telegram-id": userId }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const { messages, total } = await response.json();
        
        if (!messages || messages.length === 0) {
          statusContainer.innerHTML = `
            <div class="loading">
              <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Telegram ID: ${selectedTelegramId}</p>
              <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
                –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:<br>
                ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —Å –±–æ—Ç–æ–º<br>
                ‚Ä¢ –ù–µ–≤–µ—Ä–Ω—ã–π Telegram ID<br>
                ‚Ä¢ –î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
              </div>
            </div>
          `;
          return;
        }
        
        allMessages = messages;
        renderDataTable();
        updateStats();
        showUserInfo();
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        statusContainer.style.display = 'none';
        dataTable.style.display = 'block';
        stats.style.display = 'flex';
        userInfo.style.display = 'block';
        
      } catch (error) {
        console.error('Error loading chat data:', error);
        statusContainer.innerHTML = `
          <div class="error">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤: ${error.message}</p>
            <button onclick="loadChatData()" style="margin-top: 1rem; background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    function renderDataTable() {
      const tbody = document.getElementById('dataTableBody');
      
      tbody.innerHTML = allMessages.map(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          
          return `
            <tr>
              <td>
                <span style="font-size: 11px; color: var(--text-color); opacity: 0.7;">
                  #${msg.id}
                </span>
              </td>
              <td>
                <code style="font-size: 11px; background: var(--card-bg); padding: 2px 4px; border-radius: 3px;">
                  ${msg.session_id}
                </code>
              </td>
              <td>
                <span class="type-badge ${parsed.type}">${getTypeEmoji(parsed.type)} ${parsed.type}</span>
              </td>
              <td class="content-cell">${escapeHtml(parsed.content || '–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ')}</td>
            </tr>
          `;
        } catch (error) {
          return `
            <tr>
              <td>
                <span style="font-size: 11px; color: var(--text-color); opacity: 0.7;">
                  #${msg.id}
                </span>
              </td>
              <td>
                <code style="font-size: 11px; background: var(--card-bg); padding: 2px 4px; border-radius: 3px;">
                  ${msg.session_id}
                </code>
              </td>
              <td><span class="type-badge system">‚ö†Ô∏è error</span></td>
              <td class="content-cell">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${escapeHtml(msg.message)}</td>
            </tr>
          `;
        }
      }).join('');
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const typeCounts = { ai: 0, human: 0, system: 0, error: 0 };
      const sessionIds = new Set();
      
      allMessages.forEach(msg => {
        sessionIds.add(msg.session_id);
        try {
          const parsed = JSON.parse(msg.message);
          typeCounts[parsed.type] = (typeCounts[parsed.type] || 0) + 1;
        } catch {
          typeCounts.error++;
        }
      });
      
      stats.innerHTML = `
        <span>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${allMessages.length}</span>
        <span>–°–µ—Å—Å–∏–π: ${sessionIds.size}</span>
        <span>AI: ${typeCounts.ai}</span>
        <span>Human: ${typeCounts.human}</span>
        <span>System: ${typeCounts.system}</span>
        ${typeCounts.error > 0 ? `<span>–û—à–∏–±–∫–∏: ${typeCounts.error}</span>` : ''}
      `;
    }

    function showUserInfo() {
      const userInfo = document.getElementById('userInfo');
      const user = availableUsers.find(u => u.username === selectedTelegramId);
      
      if (user) {
        userInfo.innerHTML = `
          <div class="memory-key-info">
            <span><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${user.name} (@${user.username})</span>
            <span><strong>–Ø–∑—ã–∫:</strong> ${user.language || '‚Äî'}</span>
            <span><strong>–°–æ–æ–±—â–µ–Ω–∏–π:</strong> ${allMessages.length}</span>
            <a href="student.html?name=${encodeURIComponent(user.name)}" style="color: var(--accent-color); text-decoration: none;">
              üë§ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </a>
          </div>
        `;
      } else {
        userInfo.innerHTML = `
          <div class="memory-key-info">
            <span><strong>Telegram ID:</strong> ${selectedTelegramId}</span>
            <span><strong>–°–æ–æ–±—â–µ–Ω–∏–π:</strong> ${allMessages.length}</span>
          </div>
        `;
      }
    }

    function resetInterface() {
      allMessages = [];
      
      document.getElementById('dataTable').style.display = 'none';
      document.getElementById('stats').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
      
      document.getElementById('statusContainer').innerHTML = `
        <div class="loading">
          <p>–í—ã–±–µ—Ä–∏—Ç–µ Telegram ID –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤</p>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
            <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</strong><br>
            ‚Ä¢ üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>
            ‚Ä¢ üîç –ê–Ω–∞–ª–∏–∑ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –∞–≥–µ–Ω—Ç–∞–º–∏<br>
            ‚Ä¢ üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Å–æ–æ–±—â–µ–Ω–∏–π
          </div>
        </div>
      `;
      document.getElementById('statusContainer').style.display = 'block';
    }

    function getTypeEmoji(type) {
      const emojis = {
        ai: 'ü§ñ',
        human: 'üë§', 
        system: '‚öôÔ∏è',
        assistant: 'ü§ñ',
        user: 'üë§'
      };
      return emojis[type] || '‚ùì';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
