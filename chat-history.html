<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #202124;
      --border-color: #e0e0e0;
      --header-bg: #f1f3f4;
      --accent-color: #007aff;
      --card-bg: #f8f9fa;
      --ai-bg: #e3f2fd;
      --human-bg: #f3e5f5;
      --system-bg: #fff3e0;
      --ai-border: #2196f3;
      --human-border: #9c27b0;
      --system-border: #ff9800;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --text-color: #e1e1e1;
        --border-color: #333;
        --header-bg: #2d2d2d;
        --accent-color: #0a84ff;
        --card-bg: #2d2d2d;
        --ai-bg: #1e3a5f;
        --human-bg: #3d1a78;
        --system-bg: #5d4037;
        --ai-border: #64b5f6;
        --human-border: #ba68c8;
        --system-border: #ffb74d;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      font-size: 14px;
      margin: 0.5rem;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .header {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .session-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, input {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 14px;
    }

    .load-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .load-btn:hover {
      opacity: 0.9;
    }

    .chat-container {
      max-height: 70vh;
      overflow-y: auto;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border-color);
    }

    .message {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 12px;
      border-left: 4px solid;
      position: relative;
    }

    .message.ai {
      background: var(--ai-bg);
      border-left-color: var(--ai-border);
    }

    .message.human {
      background: var(--human-bg);
      border-left-color: var(--human-border);
    }

    .message.system {
      background: var(--system-bg);
      border-left-color: var(--system-border);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 12px;
      opacity: 0.8;
    }

    .message-type {
      font-weight: 600;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0,0,0,0.1);
    }

    .message-content {
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .tool-calls {
      margin-top: 1rem;
      padding: 0.5rem;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-color);
    }

    .error {
      color: #ff3b30;
      text-align: center;
      padding: 1rem;
      background: rgba(255, 59, 48, 0.1);
      border-radius: 6px;
      margin: 1rem 0;
    }

    .stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 12px;
      opacity: 0.7;
    }

    .filter-controls {
      margin-bottom: 1rem;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 4px 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .filter-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      padding: 0.5rem 0;
      font-size: 14px;
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .emoji {
      margin-right: 0.5rem;
    }

    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .session-selector {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="header">
    <h1><span class="emoji">üí¨</span>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h1>
    <div class="session-selector">
      <select id="sessionSelect">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é...</option>
      </select>
      <input type="text" id="customSession" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ session_id" />
      <button class="load-btn" onclick="loadChatHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
  </div>

  <div class="filter-controls" id="filterControls" style="display: none;">
    <button class="filter-btn active" onclick="filterMessages('all')">–í—Å–µ</button>
    <button class="filter-btn" onclick="filterMessages('ai')">AI</button>
    <button class="filter-btn" onclick="filterMessages('human')">Human</button>
    <button class="filter-btn" onclick="filterMessages('system')">System</button>
  </div>

  <div class="stats" id="stats" style="display: none;"></div>

  <div class="chat-container" id="chatContainer">
    <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞</div>
  </div>

  <script>
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 618647337;
    let allMessages = [];
    let currentFilter = 'all';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      loadAvailableSessions();
    });

    async function loadAvailableSessions() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è session_id
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId }
        });
        
        if (!response.ok) throw new Error('Failed to load sessions');
        
        const { students } = await response.json();
        const sessionSelect = document.getElementById('sessionSelect');
        
        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
        sessionSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é...</option>';
        
        students.forEach(student => {
          if (student.next_session_id) {
            const option = document.createElement('option');
            option.value = student.next_session_id;
            option.textContent = `${student.name} - ${student.next_session || '–ë–µ–∑ –¥–∞—Ç—ã'}`;
            sessionSelect.appendChild(option);
          }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä session_id –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        const exampleOption = document.createElement('option');
        exampleOption.value = 'student_71272569';
        exampleOption.textContent = '–ü—Ä–∏–º–µ—Ä: student_71272569 (–ö—Ä–∏—Å)';
        sessionSelect.appendChild(exampleOption);
        
      } catch (error) {
        console.error('Error loading sessions:', error);
        document.getElementById('chatContainer').innerHTML = 
          '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π</div>';
      }
    }

    async function loadChatHistory() {
      const sessionSelect = document.getElementById('sessionSelect');
      const customSession = document.getElementById('customSession');
      const sessionId = customSession.value.trim() || sessionSelect.value;
      
      if (!sessionId) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ session_id');
        return;
      }

      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞...</div>';

      try {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞
        const mockData = await getMockChatData(sessionId);
        
        allMessages = mockData;
        renderMessages();
        updateStats();
        
        document.getElementById('filterControls').style.display = 'flex';
        document.getElementById('stats').style.display = 'flex';
        
      } catch (error) {
        console.error('Error loading chat history:', error);
        chatContainer.innerHTML = 
          '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞: ' + error.message + '</div>';
      }
    }

    // –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞
    async function getMockChatData(sessionId) {
      // –ò–º–∏—Ç–∞—Ü–∏—è API –∑–∞–ø—Ä–æ—Å–∞
      await new Promise(resolve => setTimeout(resolve, 500));
      
      if (sessionId === 'student_71272569') {
        return [
          {
            id: 33,
            session_id: "student_71272569",
            message: JSON.stringify({
              type: "human",
              content: "–ü—Ä–∏–≤–µ—Ç! –ú–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ 'ringard' –≤ –º–æ–π —Å–ª–æ–≤–∞—Ä—å?",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 34,
            session_id: "student_71272569", 
            message: JSON.stringify({
              type: "ai",
              content: "–ì–æ—Ç–æ–≤–æ, –ö—Ä–∏—Å ‚Äî —è –¥–æ–±–∞–≤–∏–ª–∞ —Å–ª–æ–≤–æ ringard / ringarde –≤ —Ç–≤–æ–π —Å–ª–æ–≤–∞—Ä—å. \n\n–í–æ—Ç —á—Ç–æ —è —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞:\n- ringard / ringarde ‚Äî —Ñ—Ä–∞–Ω—Ü. (—Ä–∞–∑–≥.)\n- –ó–Ω–∞—á–µ–Ω–∏–µ: —Å—Ç–∞—Ä–æ–º–æ–¥–Ω—ã–π, –Ω–µ–º–æ–¥–Ω—ã–π, –±–µ–∑–≤–∫—É—Å–Ω—ã–π; ¬´–Ω–µ–∫—Ä—É—Ç–æ–π¬ª\n- –ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ: [ Å…õÃÉ…°a Å] (–ø—Ä–∏–º–µ—Ä–Ω–æ ¬´—Ä—ç–Ω-–≥–∞—Ä¬ª), ringarde ‚Äî [ Å…õÃÉ…°a Åd]\n- –°–∏–Ω–æ–Ω–∏–º—ã: d√©mod√©, d√©pass√©, vieillot, kitsch\n- –ü—Ä–∏–º–µ—Ä—ã: Ce pull est un peu ringard. / Ne sois pas ringard ! / Il fait des blagues ringardes.\n- session_id –Ω–µ —É–∫–∞–∑–∞–Ω\n\n–•–æ—á–µ—à—å, —è —Å–æ—Å—Ç–∞–≤–ª—é –ø–∞—Ä—É –∫–æ—Ä–æ—Ç–∫–∏—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π/–¥–∏–∞–ª–æ–≥–æ–≤ —Å —ç—Ç–∏–º —Å–ª–æ–≤–æ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—é –µ—â—ë 2-3 –ø–æ—Ö–æ–∂–∏—Ö —Å–ª–æ–≤–∞ –≤ —Å–ª–æ–≤–∞—Ä—å?",
              tool_calls: [],
              additional_kwargs: {},
              response_metadata: {},
              invalid_tool_calls: []
            })
          },
          {
            id: 35,
            session_id: "student_71272569",
            message: JSON.stringify({
              type: "human", 
              content: "–î–∞, —Å–æ—Å—Ç–∞–≤—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å —ç—Ç–∏–º —Å–ª–æ–≤–æ–º!",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 36,
            session_id: "student_71272569",
            message: JSON.stringify({
              type: "ai",
              content: "–û—Ç–ª–∏—á–Ω–æ! –í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —Å —Å–ª–æ–≤–æ–º 'ringard':\n\n**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 1: –ü–µ—Ä–µ–≤–æ–¥—ã**\n1. –≠—Ç–æ—Ç —Å–≤–∏—Ç–µ—Ä –Ω–µ–º–Ω–æ–≥–æ —Å—Ç–∞—Ä–æ–º–æ–¥–Ω—ã–π.\n2. –ù–µ –±—É–¥—å –Ω–µ–∫—Ä—É—Ç—ã–º!\n3. –û–Ω —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–Ω–∞–ª—å–Ω—ã–µ —à—É—Ç–∫–∏.\n\n**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 2: –°–∏—Ç—É–∞—Ü–∏–∏**\n–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –±—ã –≤—ã —Å–∫–∞–∑–∞–ª–∏ –ø–æ-—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏:\n- –í–∞—à –¥—Ä—É–≥ –Ω–æ—Å–∏—Ç –æ—á–µ–Ω—å —Å—Ç–∞—Ä–æ–º–æ–¥–Ω—É—é —à–ª—è–ø—É\n- –ö—Ç–æ-—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ—Å–ª—É—à–∞—Ç—å –º—É–∑—ã–∫—É 80-—Ö\n- –í—ã –≤–∏–¥–∏—Ç–µ –¥–µ–∫–æ—Ä –≤ —Å—Ç–∏–ª–µ –∫–∏—Ç—á\n\n–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Å–ª–æ–≤–∞?",
              tool_calls: [],
              additional_kwargs: {},
              response_metadata: {},
              invalid_tool_calls: []
            })
          }
        ];
      }
      
      // –î–ª—è –¥—Ä—É–≥–∏—Ö session_id –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
      return [
        {
          id: 1,
          session_id: sessionId,
          message: JSON.stringify({
            type: "system",
            content: `–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—è ${sessionId}`,
            additional_kwargs: {},
            response_metadata: {}
          })
        },
        {
          id: 2, 
          session_id: sessionId,
          message: JSON.stringify({
            type: "ai",
            content: "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∏–∑—É—á–µ–Ω–∏—é —è–∑—ã–∫–æ–≤. –ö–∞–∫ –¥–µ–ª–∞?",
            tool_calls: [],
            additional_kwargs: {},
            response_metadata: {}
          })
        }
      ];
    }

    function renderMessages() {
      const container = document.getElementById('chatContainer');
      
      const filteredMessages = currentFilter === 'all' 
        ? allMessages 
        : allMessages.filter(msg => {
            try {
              const parsed = JSON.parse(msg.message);
              return parsed.type === currentFilter;
            } catch {
              return false;
            }
          });

      if (filteredMessages.length === 0) {
        container.innerHTML = '<div class="loading">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
        return;
      }

      container.innerHTML = filteredMessages.map(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          const timestamp = new Date().toLocaleString('ru-RU'); // –ï—Å–ª–∏ –µ—Å—Ç—å timestamp –≤ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ
          
          return `
            <div class="message ${parsed.type}">
              <div class="message-header">
                <span class="message-type">${getTypeEmoji(parsed.type)} ${parsed.type}</span>
                <span>ID: ${msg.id} | ${timestamp}</span>
              </div>
              <div class="message-content">${escapeHtml(parsed.content)}</div>
              ${parsed.tool_calls && parsed.tool_calls.length > 0 ? `
                <div class="tool-calls">
                  <strong>Tool calls:</strong> ${JSON.stringify(parsed.tool_calls, null, 2)}
                </div>
              ` : ''}
              ${parsed.invalid_tool_calls && parsed.invalid_tool_calls.length > 0 ? `
                <div class="tool-calls">
                  <strong>Invalid tool calls:</strong> ${JSON.stringify(parsed.invalid_tool_calls, null, 2)}
                </div>
              ` : ''}
            </div>
          `;
        } catch (error) {
          return `
            <div class="message system">
              <div class="message-header">
                <span class="message-type">‚ö†Ô∏è ERROR</span>
                <span>ID: ${msg.id}</span>
              </div>
              <div class="message-content">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${escapeHtml(msg.message)}</div>
            </div>
          `;
        }
      }).join('');
    }

    function filterMessages(type) {
      currentFilter = type;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderMessages();
      updateStats();
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const typeCounts = { ai: 0, human: 0, system: 0, error: 0 };
      
      allMessages.forEach(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          typeCounts[parsed.type] = (typeCounts[parsed.type] || 0) + 1;
        } catch {
          typeCounts.error++;
        }
      });
      
      stats.innerHTML = `
        <span>–í—Å–µ–≥–æ: ${allMessages.length}</span>
        <span>AI: ${typeCounts.ai}</span>
        <span>Human: ${typeCounts.human}</span>
        <span>System: ${typeCounts.system}</span>
        ${typeCounts.error > 0 ? `<span>–û—à–∏–±–∫–∏: ${typeCounts.error}</span>` : ''}
      `;
    }

    function getTypeEmoji(type) {
      const emojis = {
        ai: 'ü§ñ',
        human: 'üë§', 
        system: '‚öôÔ∏è',
        assistant: 'ü§ñ',
        user: 'üë§'
      };
      return emojis[type] || '‚ùì';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById('customSession').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadChatHistory();
      }
    });
  </script>
</body>
</html>
