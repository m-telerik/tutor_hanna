<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/student.css">
</head>
<body>
  <div class="page-content">
    <div class="header">
      <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
      <h1><span class="emoji">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞</h1>
      <div class="header-help">
        <a href="https://t.me/tutor_hanna_bot" target="_blank" class="help-link">
          <span class="emoji">üí¨</span>
          <span class="help-text">–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?</span>
        </a>
      </div>
    </div>

    <div class="page-layout">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ -->
      <div class="left-column" id="left-column">
        <div class="student-header">
          <h2><span class="emoji">üë§</span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        </div>
        
        <div id="student-info">
          <div class="loading-state">
            <span class="loading-spinner"></span>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
          </div>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ª–æ–≤–∞—Ä—å -->
      <div class="right-column" id="right-column">
        <div class="vocab-header">
          <h2><span class="emoji">üìö</span>–°–ª–æ–≤–∞—Ä—å</h2>
          <div class="vocab-count" id="vocab-count">0 —Å–ª–æ–≤</div>
        </div>
        
        <div id="vocabulary-content">
          <div class="loading-state">
            <span class="loading-spinner"></span>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤–∞—Ä—è...</p>
          </div>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div class="pagination-container" id="pagination-container" style="display: none;">
          <div class="pagination-info">
            <span id="pagination-info">–ü–æ–∫–∞–∑–∞–Ω–æ: 1-10 –∏–∑ 25</span>
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" id="prev-btn" onclick="changePage(-1)" disabled>
              ‚Üê –ù–∞–∑–∞–¥
            </button>
            <span class="page-indicator" id="page-indicator">1 / 3</span>
            <button class="pagination-btn" id="next-btn" onclick="changePage(1)">
              –í–ø–µ—Ä—ë–¥ ‚Üí
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ñ—É—Ç–µ—Ä -->
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const studentName = urlParams.get("name");
    
    // –ü–æ–ª—É—á–∞–µ–º userId
    let userId = null;
    try {
      userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    } catch (error) {
      console.log('Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
    }
    
    if (!userId) {
      userId = 618647337; // –¢–µ—Å—Ç–æ–≤—ã–π ID –∞–¥–º–∏–Ω–∞
    }
    
    let studentData = null;
    let allVocabWords = [];
    let currentPage = 1;
    const wordsPerPage = 10;

    if (!studentName) {
      document.getElementById('student-info').innerHTML = `
        <div class="error-state">
          <h3>–û—à–∏–±–∫–∞</h3>
          <p>–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞</p>
        </div>
      `;
    } else {
      loadStudentInfo();
      loadVocabulary();
    }

    async function loadStudentInfo() {
      try {
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId.toString() }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const { students } = await response.json();
        const student = students.find(s => s.name === studentName);

        if (!student) {
          throw new Error('–°—Ç—É–¥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        studentData = student;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.title = `–ü—Ä–æ—Ñ–∏–ª—å: ${student.name}`;
        document.querySelector('h1').innerHTML = `<span class="emoji">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å: ${student.name}`;

        // –†–µ–∂–∏–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        const bookingMode = student.booking_mode === 'by_student' 
          ? 'üìÖ –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ' 
          : 'üéì –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º';

        const bookingClass = student.booking_mode === 'by_student' ? 'by-student' : 'by-teacher';

        // –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è (–ø–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–µ–µ)
        const lessonsHtml = student.next_session ? `
          <a href="lesson.html?session_id=${student.next_session_id}" class="lesson-item">
            <div class="lesson-date">${student.next_session}</div>
            <div class="lesson-language">${student.language}</div>
          </a>
        ` : `
          <div class="no-lessons">
            –ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π
          </div>
        `;

        // –†–µ–Ω–¥–µ—Ä–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        document.getElementById('student-info').innerHTML = `
          <ul class="info-list">
            <li class="info-item">
              <span class="info-label">–ò–º—è:</span>
              <span class="info-value">${student.name}</span>
            </li>
            
            ${student.email ? `
              <li class="info-item">
                <span class="info-label">Email:</span>
                <span class="info-value">${student.email}</span>
              </li>
            ` : ''}
            
            ${student.username ? `
              <li class="info-item">
                <span class="info-label">Telegram:</span>
                <span class="info-value">
                  <a href="https://t.me/${student.username}" target="_blank" style="color: var(--accent-color);">
                    @${student.username}
                  </a>
                </span>
              </li>
            ` : ''}
            
            <li class="info-item">
              <span class="info-label">–Ø–∑—ã–∫:</span>
              <span class="info-value">
                <span class="language-badge">${student.language || '‚Äî'}</span>
              </span>
            </li>
            
            <li class="info-item">
              <span class="info-label">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</span>
              <span class="info-value">
                <span class="booking-badge ${bookingClass}">${bookingMode}</span>
              </span>
            </li>
            
            ${student.frequency ? `
              <li class="info-item">
                <span class="info-label">–ß–∞—Å—Ç–æ—Ç–∞:</span>
                <span class="info-value">${student.frequency}x –≤ –Ω–µ–¥–µ–ª—é</span>
              </li>
            ` : ''}
            
            ${student.preferred_time ? `
              <li class="info-item">
                <span class="info-label">–í—Ä–µ–º—è:</span>
                <span class="info-value">${student.preferred_time}</span>
              </li>
            ` : ''}
            
            ${student.preferred_days && student.preferred_days.length > 0 ? `
              <li class="info-item">
                <span class="info-label">–î–Ω–∏:</span>
                <span class="info-value">${student.preferred_days.join(', ')}</span>
              </li>
            ` : ''}
          </ul>

          <div class="lessons-section">
            <h3><span class="emoji">üìÖ</span>–ó–∞–Ω—è—Ç–∏—è</h3>
            <div class="lessons-list" id="lessons-list">
              ${lessonsHtml}
            </div>
          </div>

          <button class="book-button" onclick="openBooking()">
            <span class="emoji">üìÖ</span>
            –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ
          </button>
        `;

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–ª–æ–Ω–æ–∫
        syncColumnHeights();

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞:', error);
        document.getElementById('student-info').innerHTML = `
          <div class="error-state">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>${error.message}</p>
            <button onclick="loadStudentInfo()" class="btn-primary" style="margin-top: 1rem;">
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    async function loadVocabulary() {
      try {
        const response = await fetch(`/api/vocab?user_name=${encodeURIComponent(studentName)}`, {
          headers: { "x-telegram-id": userId.toString() }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const { words = [] } = await response.json();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å–ª–æ–≤–∞ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
        allVocabWords = words.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        currentPage = 1;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        updateVocabularyDisplay();
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–ª–æ–Ω–æ–∫
        setTimeout(syncColumnHeights, 100);

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è:', error);
        document.getElementById('vocabulary-content').innerHTML = `
          <div class="error-state">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è</h3>
            <p>${error.message}</p>
            <button onclick="loadVocabulary()" class="btn-primary" style="margin-top: 1rem;">
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    function updateVocabularyDisplay() {
      const totalWords = allVocabWords.length;
      const totalPages = Math.ceil(totalWords / wordsPerPage);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
      const englishWords = allVocabWords.filter(w => w.language === 'english').length;
      const frenchWords = allVocabWords.filter(w => w.language === 'french').length;
      
      document.getElementById('vocab-count').innerHTML = `
        ${totalWords} —Å–ª–æ–≤
        ${englishWords > 0 || frenchWords > 0 ? `<br><small style="opacity: 0.8; font-size: 10px;">
          ${englishWords > 0 ? `EN: ${englishWords}` : ''}
          ${englishWords > 0 && frenchWords > 0 ? ' ‚Ä¢ ' : ''}
          ${frenchWords > 0 ? `FR: ${frenchWords}` : ''}
        </small>` : ''}
      `;

      if (totalWords === 0) {
        document.getElementById('vocabulary-content').innerHTML = `
          <div class="empty-vocab">
            <span class="emoji">üìö</span>
            <p>–°–ª–æ–≤–∞—Ä—å –ø–æ–∫–∞ –ø—É—Å—Ç</p>
            <p style="font-size: 11px; opacity: 0.7;">–°–ª–æ–≤–∞ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –ø–æ—Å–ª–µ —É—Ä–æ–∫–æ–≤</p>
          </div>
        `;
        document.getElementById('pagination-container').style.display = 'none';
        return;
      }

      // –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const startIndex = (currentPage - 1) * wordsPerPage;
      const endIndex = startIndex + wordsPerPage;
      const currentWords = allVocabWords.slice(startIndex, endIndex);

      // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
      document.getElementById('vocabulary-content').innerHTML = `
        <table class="vocab-table">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–°–ª–æ–≤–æ</th>
              <th>–ü–µ—Ä–µ–≤–æ–¥</th>
              <th>–ü—Ä–∏–º–µ—Ä</th>
            </tr>
          </thead>
          <tbody>
            ${currentWords.map(word => `
              <tr>
                <td class="date-cell">
                  ${word.created_at ? new Date(word.created_at).toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit'
                  }) : '‚Äî'}
                </td>
                <td class="word-cell">
                  ${word.word}
                  ${word.language ? `<br><small style="color: var(--accent-color); font-size: 9px; opacity: 0.8;">${word.language.toUpperCase()}</small>` : ''}
                </td>
                <td class="translation-cell">${word.translation || '‚Äî'}</td>
                <td class="example-cell" title="${word.example || ''}">${word.example || '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
      if (totalPages > 1) {
        document.getElementById('pagination-container').style.display = 'flex';
        updatePaginationControls(startIndex + 1, Math.min(endIndex, totalWords), totalWords, currentPage, totalPages);
      } else {
        document.getElementById('pagination-container').style.display = 'none';
      }
    }

    function updatePaginationControls(start, end, total, page, totalPages) {
      document.getElementById('pagination-info').textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${start}-${end} –∏–∑ ${total}`;
      document.getElementById('page-indicator').textContent = `${page} / ${totalPages}`;
      
      document.getElementById('prev-btn').disabled = page === 1;
      document.getElementById('next-btn').disabled = page === totalPages;
    }

    function changePage(direction) {
      const totalPages = Math.ceil(allVocabWords.length / wordsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        updateVocabularyDisplay();
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É —Ç–∞–±–ª–∏—Ü—ã
        document.getElementById('vocabulary-content').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        setTimeout(syncColumnHeights, 100);
      }
    }

    function syncColumnHeights() {
      const leftColumn = document.getElementById('left-column');
      const rightColumn = document.getElementById('right-column');
      
      if (leftColumn && rightColumn) {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
        leftColumn.style.height = 'auto';
        rightColumn.style.height = 'auto';
        
        // –ñ–¥–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        setTimeout(() => {
          const rightHeight = rightColumn.offsetHeight;
          const leftHeight = leftColumn.offsetHeight;
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –≤—ã—Å–æ—Ç—É
          const maxHeight = Math.max(rightHeight, leftHeight);
          leftColumn.style.height = maxHeight + 'px';
          rightColumn.style.height = maxHeight + 'px';
        }, 50);
      }
    }

    function openBooking() {
      const bookingUrl = 'https://calendar.app.google/SQGJj626MUyQ6DYL6';
      
      if (window.Telegram?.WebApp?.openLink) {
        window.Telegram.WebApp.openLink(bookingUrl);
      } else {
        window.open(bookingUrl, '_blank');
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    if (window.Telegram?.WebApp) {
      try {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      } catch (error) {
        console.log('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
      }
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', () => {
      setTimeout(syncColumnHeights, 100);
    });

    console.log('Student profile –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è:', studentName);
  </script>
</body>
</html>
