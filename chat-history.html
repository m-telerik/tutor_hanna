<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/chat-history.css">
</head>
<body>
  <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="header">
    <h1><span class="emoji">üí¨</span>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h1>
    
    <div class="navigation-panel">
      <!-- –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id -->
      <div class="step">
        <div class="step-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</div>
        <div class="step-controls">
          <select id="telegramIdSelect" onchange="onTelegramIdChange()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>
          </select>
          <button class="load-btn" onclick="loadChatData()" disabled id="loadDataBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats" id="stats" style="display: none;"></div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
  <div id="userInfo" style="display: none;"></div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
  <div class="data-table" id="dataTable" style="display: none;">
    <table>
      <thead>
        <tr>
          <th>Session ID</th>
          <th>–¢–∏–ø –∞–≥–µ–Ω—Ç–∞</th>
          <th>–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è</th>
          <th>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</th>
          <th>–í—Ä–µ–º—è</th>
        </tr>
      </thead>
      <tbody id="dataTableBody">
      </tbody>
    </table>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ -->
  <div id="statusContainer">
    <div class="loading">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤</p>
      <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
        <strong>–ß—Ç–æ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:</strong><br>
        ‚Ä¢ üí¨ –í—Å–µ –¥–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≥–µ–Ω—Ç–∞–º–∏<br>
        ‚Ä¢ ü§ñ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç AI –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>
        ‚Ä¢ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–±—â–µ–Ω–∏—é
      </div>
    </div>
  </div>

  <script>
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 618647337;
    let currentTelegramId = '';
    let allMessages = [];
    let availableUsers = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      
      loadAvailableUsers();
    });

    async function loadAvailableUsers() {
      try {
        console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId }
        });
        
        if (response.ok) {
          const { students } = await response.json();
          console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:', students.length);
          
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
          const processedStudents = students.map(student => ({
            name: student.name,
            telegram_id: student.telegram_id || undefined, // –ú–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö
            username: student.username || null, // –ú–æ–∂–µ—Ç –±—ã—Ç—å null/undefined
            email: student.email || null,
            role: 'student'
          })).filter(student => student.telegram_id !== undefined); // –£–±–∏—Ä–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –±–µ–∑ telegram_id
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
          const adminUsers = [
            { 
              name: '–ê–Ω–Ω–∞ (–∞–¥–º–∏–Ω)', 
              telegram_id: 618647337, 
              username: 'admin1',
              email: 'admin@hanna.com',
              role: 'admin'
            },
            { 
              name: '–ú–∞—Ä–∏–Ω–∞ (–∞–¥–º–∏–Ω)', 
              telegram_id: 2341205, 
              username: 'admin2',
              email: 'admin2@hanna.com',
              role: 'admin'
            }
          ];
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
          const sortedStudents = processedStudents.sort((a, b) => a.name.localeCompare(b.name));
          
          availableUsers = [...adminUsers, ...sortedStudents];
          populateUserSelect();
          
          console.log('üìã –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞:', availableUsers.length);
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        availableUsers = [
          { name: '–ê–Ω–Ω–∞ (–∞–¥–º–∏–Ω)', telegram_id: 618647337, username: 'admin1', role: 'admin' },
          { name: '–ú–∞—Ä–∏–Ω–∞ (–∞–¥–º–∏–Ω)', telegram_id: 2341205, username: 'admin2', role: 'admin' },
          { name: '–ú–∏—Ö–∞–∏–ª', telegram_id: 96911488, username: 'YoroolGui', role: 'student' },
          { name: '–Æ–ª–∏—è', telegram_id: 396796964, username: 'juliia_go', role: 'student' },
          { name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', telegram_id: 123456789, username: null, role: 'student' }
        ];
        populateUserSelect();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        showNotification('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.', 'warning');
      }
    }

    function populateUserSelect() {
      const select = document.getElementById('telegramIdSelect');
      
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>';
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ä–æ–ª–∏
      const admins = availableUsers.filter(u => u.role === 'admin');
      const students = availableUsers.filter(u => u.role !== 'admin');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
      if (admins.length > 0) {
        const adminGroup = document.createElement('optgroup');
        adminGroup.label = 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã';
        admins.forEach(user => {
          const option = document.createElement('option');
          option.value = user.telegram_id;
          
          // –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          const displayName = user.name;
          const displayUsername = user.username ? `@${user.username}` : '–±–µ–∑ username';
          const displayId = `ID: ${user.telegram_id}`;
          
          option.textContent = `${displayName} (${displayUsername}) - ${displayId}`;
          adminGroup.appendChild(option);
        });
        select.appendChild(adminGroup);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
      if (students.length > 0) {
        const studentGroup = document.createElement('optgroup');
        studentGroup.label = 'üßë‚Äçüéì –°—Ç—É–¥–µ–Ω—Ç—ã';
        students.forEach(user => {
          const option = document.createElement('option');
          option.value = user.telegram_id;
          
          // –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
          const displayName = user.name;
          const displayUsername = user.username ? `@${user.username}` : '–±–µ–∑ username';
          const displayId = `ID: ${user.telegram_id}`;
          
          option.textContent = `${displayName} (${displayUsername}) - ${displayId}`;
          studentGroup.appendChild(option);
        });
        select.appendChild(studentGroup);
      }
      
      console.log('üìù –ó–∞–ø–æ–ª–Ω–µ–Ω select —Å', availableUsers.length, '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏');
    }

    function onTelegramIdChange() {
      const select = document.getElementById('telegramIdSelect');
      const loadBtn = document.getElementById('loadDataBtn');
      
      currentTelegramId = select.value;
      loadBtn.disabled = !currentTelegramId;
      
      // –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      resetInterface();
    }

    async function loadChatData() {
      const statusContainer = document.getElementById('statusContainer');
      const dataTable = document.getElementById('dataTable');
      const stats = document.getElementById('stats');
      const userInfo = document.getElementById('userInfo');
      
      if (!currentTelegramId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      statusContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤...</div>';
      dataTable.style.display = 'none';
      stats.style.display = 'none';
      userInfo.style.display = 'none';

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API endpoint
        const response = await fetch(`/api/chat-history?telegram_id=${currentTelegramId}`, {
          headers: { "x-telegram-id": userId }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const { messages, user_info } = await response.json();
        
        console.log('üìä –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', {
          messages: messages?.length || 0,
          user_info,
          firstMessage: messages?.[0],
          messageTypes: messages?.map(m => typeof m.message).slice(0, 5)
        });
        
        if (!messages || messages.length === 0) {
          statusContainer.innerHTML = '<div class="loading">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
          return;
        }
        
        allMessages = messages;
        renderDataTable();
        updateStats();
        showUserInfo(user_info || getSelectedUserInfo());
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        statusContainer.style.display = 'none';
        dataTable.style.display = 'block';
        stats.style.display = 'flex';
        userInfo.style.display = 'block';
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤:', error);
        
        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤';
        if (error.message.includes('column') && error.message.includes('does not exist')) {
          errorMessage = '–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.';
        } else if (error.message.includes('403')) {
          errorMessage = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.';
        } else if (error.message.includes('404')) {
          errorMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.';
        }
        
        statusContainer.innerHTML = `
          <div class="error">
            <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p><strong>–î–µ—Ç–∞–ª–∏:</strong> ${errorMessage}</p>
            <details style="margin-top: 1rem; font-size: 12px; opacity: 0.8;">
              <summary style="cursor: pointer;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</summary>
              <pre style="background: var(--card-bg); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; overflow-x: auto;">${error.message}</pre>
            </details>
            <button onclick="loadChatData()" style="margin-top: 1rem; background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
              üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    function getSelectedUserInfo() {
      return availableUsers.find(u => u.telegram_id == currentTelegramId) || 
             { name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', telegram_id: currentTelegramId };
    }

    function renderDataTable() {
      const tbody = document.getElementById('dataTableBody');
      
      if (allMessages.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 2rem; opacity: 0.6;">
              <div style="font-size: 3em;">üí¨</div>
              <p style="margin: 1rem 0;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
              <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = allMessages.map((msg, index) => {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ message —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
          if (!msg.message || typeof msg.message !== 'string') {
            console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', msg);
            return `
              <tr class="error-row">
                <td colspan="5" style="background: rgba(220, 53, 69, 0.1); color: var(--error-color); text-align: center; padding: 1rem;">
                  ‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è ID: ${msg.id}
                  <br><small>–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: ${typeof msg.message}</small>
                </td>
              </tr>
            `;
          }

          const parsed = JSON.parse(msg.message);
          const timestamp = formatTimeAgo(msg.created_at);
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∞–≥–µ–Ω—Ç–∞ –∏–∑ session_id
          let agentType = 'unknown';
          let agentLabel = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          
          if (msg.session_id.startsWith('hanna_user_')) {
            agentType = 'tutor';
            agentLabel = 'ü§ñ TutorBot';
          } else if (msg.session_id.startsWith('student_')) {
            agentType = 'student';
            agentLabel = 'üë§ Student Agent';
          } else if (msg.session_id.startsWith('lead_')) {
            agentType = 'lead';
            agentLabel = 'üåü Lead Agent';
          } else if (msg.session_id.startsWith('calendar_')) {
            agentType = 'calendar';
            agentLabel = 'üìÖ Calendar Agent';
          }
          
          // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
          const content = parsed.content || '–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ';
          const contentStr = typeof content === 'string' ? content : JSON.stringify(content);
          const contentPreview = contentStr.length > 120 ? contentStr.substring(0, 120) + '...' : contentStr;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —á–µ—Ç–Ω—ã—Ö/–Ω–µ—á–µ—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫
          const rowClass = index % 2 === 0 ? 'even-row' : 'odd-row';
          
          return `
            <tr class="${rowClass}" data-message-id="${msg.id}">
              <td style="font-family: monospace; font-size: 11px; max-width: 200px; word-break: break-all;">
                <div style="background: var(--card-bg); padding: 4px 6px; border-radius: 4px; border: 1px solid var(--border-color);">
                  ${escapeHtml(msg.session_id)}
                </div>
                <small style="opacity: 0.6; margin-top: 2px; display: block;">ID: ${msg.id}</small>
              </td>
              <td style="text-align: center;">
                <span class="agent-badge ${agentType}">${agentLabel}</span>
              </td>
              <td style="text-align: center;">
                <span class="type-badge ${parsed.type || 'unknown'}">${getTypeEmoji(parsed.type || 'unknown')} ${parsed.type || 'unknown'}</span>
              </td>
              <td class="content-cell" title="${escapeHtml(contentStr)}">
                ${escapeHtml(contentPreview)}
                ${contentStr.length > 120 ? '<br><small style="opacity: 0.6; font-style: italic;">–ù–∞–≤–µ–¥–∏—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</small>' : ''}
              </td>
              <td style="white-space: nowrap; font-size: 12px;">
                <div title="${msg.created_at ? new Date(msg.created_at).toLocaleString('ru-RU') : '–í—Ä–µ–º—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ ID)'}">
                  ${timestamp}
                </div>
              </td>
            </tr>
          `;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error, msg);
          return `
            <tr class="error-row">
              <td colspan="5" style="background: rgba(220, 53, 69, 0.1); color: var(--error-color); text-align: center; padding: 1rem;">
                ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ID: ${msg.id}
                <br><small>–û—à–∏–±–∫–∞: ${error.message}</small>
                <br><small>–î–∞–Ω–Ω—ã–µ: ${typeof msg.message === 'string' ? escapeHtml(msg.message.substring(0, 100)) : '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö'}...</small>
              </td>
            </tr>
          `;
        }
      }).join('');
      
      console.log('‚úÖ –û—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å', allMessages.length, '—Å–æ–æ–±—â–µ–Ω–∏—è–º–∏');
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const typeCounts = { ai: 0, human: 0, system: 0, error: 0 };
      const agentCounts = { tutor: 0, student: 0, lead: 0, calendar: 0, unknown: 0 };
      
      allMessages.forEach(msg => {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ message —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
          if (!msg.message || typeof msg.message !== 'string') {
            typeCounts.error++;
            return;
          }
          
          const parsed = JSON.parse(msg.message);
          const messageType = parsed.type || 'unknown';
          typeCounts[messageType] = (typeCounts[messageType] || 0) + 1;
          
          // –ü–æ–¥—Å—á–µ—Ç –ø–æ –∞–≥–µ–Ω—Ç–∞–º
          if (msg.session_id.startsWith('hanna_user_')) agentCounts.tutor++;
          else if (msg.session_id.startsWith('student_')) agentCounts.student++;
          else if (msg.session_id.startsWith('lead_')) agentCounts.lead++;
          else if (msg.session_id.startsWith('calendar_')) agentCounts.calendar++;
          else agentCounts.unknown++;
        } catch (error) {
          typeCounts.error++;
          console.warn('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ:', error, msg);
        }
      });
      
      stats.innerHTML = `
        <span><strong>–í—Å–µ–≥–æ:</strong> ${allMessages.length}</span>
        <span><strong>AI:</strong> ${typeCounts.ai || 0}</span>
        <span><strong>Human:</strong> ${typeCounts.human || 0}</span>
        <span><strong>System:</strong> ${typeCounts.system || 0}</span>
        <span><strong>TutorBot:</strong> ${agentCounts.tutor}</span>
        <span><strong>Student:</strong> ${agentCounts.student}</span>
        <span><strong>Lead:</strong> ${agentCounts.lead}</span>
        <span><strong>Calendar:</strong> ${agentCounts.calendar}</span>
        ${typeCounts.error > 0 ? `<span style="color: var(--error-color);"><strong>–û—à–∏–±–∫–∏:</strong> ${typeCounts.error}</span>` : ''}
        ${agentCounts.unknown > 0 ? `<span style="color: var(--error-color);"><strong>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ:</strong> ${agentCounts.unknown}</span>` : ''}
      `;
    }

    function showUserInfo(userInfo) {
      const userInfoDiv = document.getElementById('userInfo');
      
      // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const name = userInfo?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      const telegramId = userInfo?.telegram_id || currentTelegramId;
      const username = userInfo?.username || null;
      const email = userInfo?.email || null;
      
      userInfoDiv.innerHTML = `
        <div class="memory-key-info">
          <span><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${escapeHtml(name)}</span>
          <span><strong>Telegram ID:</strong> ${telegramId}</span>
          <span><strong>Username:</strong> ${username ? `@${escapeHtml(username)}` : '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
          ${email ? `<span><strong>Email:</strong> ${escapeHtml(email)}</span>` : ''}
          <span><strong>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong> ${allMessages.length}</span>
        </div>
      `;
    }

    function resetInterface() {
      allMessages = [];
      
      document.getElementById('dataTable').style.display = 'none';
      document.getElementById('stats').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
      
      document.getElementById('statusContainer').innerHTML = `
        <div class="loading">
          <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤</p>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
            <strong>–ß—Ç–æ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:</strong><br>
            ‚Ä¢ üí¨ –í—Å–µ –¥–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≥–µ–Ω—Ç–∞–º–∏<br>
            ‚Ä¢ ü§ñ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç AI –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>
            ‚Ä¢ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–±—â–µ–Ω–∏—é
          </div>
        </div>
      `;
      document.getElementById('statusContainer').style.display = 'block';
    }

    function getTypeEmoji(type) {
      const emojis = {
        ai: 'ü§ñ',
        human: 'üë§', 
        system: '‚öôÔ∏è',
        assistant: 'ü§ñ',
        user: 'üë§'
      };
      return emojis[type] || '‚ùì';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; 
        top: 20px; 
        right: 20px; 
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : type === 'warning' ? '#ff9800' : 'var(--accent-color)'}; 
        color: white; 
        padding: 12px 20px; 
        border-radius: 8px; 
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-width: 300px;
        font-size: 13px;
        animation: slideInRight 0.3s ease-out;
        line-height: 1.4;
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
      if (!document.getElementById('notificationStyles')) {
        const style = document.createElement('style');
        style.id = 'notificationStyles';
        style.textContent = `
          @keyframes slideInRight {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          @keyframes slideOutRight {
            from {
              transform: translateX(0);
              opacity: 1;
            }
            to {
              transform: translateX(100%);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        if (document.body.contains(notification)) {
          notification.style.animation = 'slideOutRight 0.3s ease-out';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }
      }, 4000);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    function formatTimeAgo(dateString) {
      if (!dateString) return 'ID-–ø–æ—Ä—è–¥–æ–∫';
      
      try {
        const now = new Date();
        const date = new Date(dateString);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
        if (isNaN(date.getTime())) {
          return 'ID-–ø–æ—Ä—è–¥–æ–∫';
        }
        
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
        if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
        if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
        if (diffDays < 7) return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
        
        return date.toLocaleString('ru-RU', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return 'ID-–ø–æ—Ä—è–¥–æ–∫';
      }
    }
  </script>
  
  <style>
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ */
    .step {
      margin-bottom: 1rem;
    }
    
    .step-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-color);
      font-size: 14px;
    }
    
    .step-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    #telegramIdSelect {
      flex: 1;
      min-width: 300px;
      padding: 10px 14px;
      border: 2px solid var(--input-border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-color);
      transition: border-color 0.2s;
    }
    
    #telegramIdSelect:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
</body>
</html>
