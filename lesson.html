<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–£—Ä–æ–∫</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="js/auth.js"></script>
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <div id="lessonContent" style="display: none;">
    <button onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>

    <h1>–£—Ä–æ–∫</h1>
    <div class="info" id="lesson-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="stats" id="vocab-stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-number" id="total-words">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ —Å–ª–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="lesson-words">0</div>
        <div class="stat-label">–°–ª–æ–≤ –≤ —É—Ä–æ–∫–µ</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="studied-words">0</div>
        <div class="stat-label">–ò–∑—É—á–µ–Ω–æ</div>
      </div>
    </div>

    <div class="vocab">
      <div class="vocab-section">
        <h2><span class="emoji">üìù</span>–°–ª–æ–≤–∞ —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞</h2>
        <table id="lesson-vocab-table">
          <thead>
            <tr>
              <th>–°–ª–æ–≤–æ</th>
              <th>–ü–µ—Ä–µ–≤–æ–¥</th>
              <th>–ü—Ä–∏–º–µ—Ä</th>
              <th>–Ø–∑—ã–∫</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="vocab-section">
        <h3><span class="emoji">üß†</span>–í–µ—Å—å —Å–ª–æ–≤–∞—Ä—å —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
        <a href="#" class="vocabulary-link" id="full-vocab-link">
          <span class="emoji">üìö</span>–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å
        </a>
        <table id="all-vocab-table">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞ —É—Ä–æ–∫–∞</th>
              <th>–°–ª–æ–≤–æ</th>
              <th>–ü–µ—Ä–µ–≤–æ–¥</th>
              <th>–ü—Ä–∏–º–µ—Ä</th>
              <th>–Ø–∑—ã–∫</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="vocab-form-container">
      <!-- –§–æ—Ä–º–∞ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ —Ç—å—é—Ç–æ—Ä–æ–≤ -->
    </div>
  </div>

  <script>
    const sessionId = new URLSearchParams(window.location.search).get("session_id");
    let auth = null;
    let currentStudentName = "";
    let currentStudentId = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Ä–æ–∫–∞...');
      
      if (!sessionId) {
        showError('–ù–µ —É–∫–∞–∑–∞–Ω ID –∑–∞–Ω—è—Ç–∏—è');
        return;
      }

      try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é - –¥–æ—Å—Ç—É–ø –¥–ª—è –∞–¥–º–∏–Ω–æ–≤, —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ —Ç—å—é—Ç–æ—Ä–æ–≤
        auth = new AuthSystem();
        const user = await auth.init(['admin', 'student', 'tutor'], onAuthSuccess, onAuthFail);
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
      }
    });

    // –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    function onAuthSuccess(user) {
      console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—Ä–æ–∫–∞:', user);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
      document.getElementById('lessonContent').style.display = 'block';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ —Ç—å—é—Ç–æ—Ä–æ–≤
      if (user.role === 'admin' || user.role === 'tutor') {
        showVocabForm();
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      loadLesson();
      loadVocab();
    }

    // –ù–µ—É–¥–∞—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    function onAuthFail(error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
      // AuthSystem —Å–∞–º –ø–æ–∫–∞–∂–µ—Ç —ç–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏
    }

    async function loadLesson() {
      try {
        const response = await auth.apiRequest('/api/students');
        const { students } = await response.json();
        const student = students.find(s => s.next_session_id == sessionId);

        if (!student) {
          document.getElementById("lesson-info").innerHTML = "–£—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.";
          return;
        }

        currentStudentName = student.name;

        document.getElementById("lesson-info").innerHTML = `
          <p><strong>–î–∞—Ç–∞:</strong> ${student.next_session}</p>
          <p><strong>–£—á–µ–Ω–∏–∫:</strong> <a href="student.html?name=${encodeURIComponent(student.name)}">${student.name}</a></p>
          <p><strong>–Ø–∑—ã–∫:</strong> ${student.language || '‚Äî'}</p>
          <p><strong>–¢–∏–ø:</strong> ${student.type || '‚Äî'}</p>
          <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${student.status || '‚Äî'}</p>
        `;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–ª–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å
        document.getElementById('full-vocab-link').href = `vocabulary.html?user_id=${encodeURIComponent(student.id || student.user_id)}`;
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞:', error);
        document.getElementById("lesson-info").innerHTML = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞: ${error.message}`;
      }
    }

    async function loadVocab() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Ä–æ–∫–∞
        const lessonRes = await auth.apiRequest(`/api/vocab?session_id=${sessionId}`);
        const { words: lessonWords = [] } = await lessonRes.json();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–ª–æ–≤–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞
        if (currentStudentId) {
          const allRes = await auth.apiRequest(`/api/vocab?user_id=${encodeURIComponent(currentStudentId)}`);
          const { words: allWords = [] } = await allRes.json();

          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ª–æ–≤–∞ —É—Ä–æ–∫–∞
          const lessonVocabTable = document.querySelector("#lesson-vocab-table tbody");
          lessonVocabTable.innerHTML = lessonWords.map(w => `
            <tr>
              <td><strong>${w.word}</strong></td>
              <td>${w.translation || ''}</td>
              <td>${w.example || ''}</td>
              <td>${w.language ? `<span style="color: var(--accent-color);">${w.language}</span>` : '‚Äî'}</td>
            </tr>
          `).join('');

          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Å–ª–æ–≤–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞
          const allVocabTable = document.querySelector("#all-vocab-table tbody");
          allVocabTable.innerHTML = allWords.map(w => `
            <tr class="${w.session_id === sessionId ? 'current-lesson' : ''}">
              <td>${w.session_date ? new Date(w.session_date).toLocaleDateString('ru-RU') : '‚Äî'}</td>
              <td><strong>${w.word}</strong></td>
              <td>${w.translation || ''}</td>
              <td>${w.example || ''}</td>
              <td>${w.language ? `<span style="color: var(--accent-color);">${w.language}</span>` : '‚Äî'}</td>
            </tr>
          `).join('');

          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          updateStats(lessonWords, allWords);
          document.getElementById('vocab-stats').style.display = 'grid';
        }

      } catch (error) {
        console.error('Error loading vocabulary:', error);
        document.querySelector("#lesson-vocab-table tbody").innerHTML = '<tr><td colspan="4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è</td></tr>';
      }
    }

    function updateStats(lessonWords, allWords) {
      document.getElementById('total-words').textContent = allWords.length;
      document.getElementById('lesson-words').textContent = lessonWords.length;
      document.getElementById('studied-words').textContent = allWords.filter(w => w.studied_count > 0).length;
    }

    function showVocabForm() {
      const container = document.getElementById('vocab-form-container');
      container.innerHTML = `
        <form id="vocab-form">
          <h3><span class="emoji">‚ûï</span>–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ</h3>
          <label>–°–ª–æ–≤–æ: <input type="text" name="word" required /></label>
          <label>–ü–µ—Ä–µ–≤–æ–¥: <input type="text" name="translation" /></label>
          <label>–ü—Ä–∏–º–µ—Ä: <textarea name="example" rows="2"></textarea></label>
          <label>–Ø–∑—ã–∫: 
            <select name="language">
              <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
              <option value="english">English</option>
              <option value="french">French</option>
            </select>
          </label>
          <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
      `;

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
      document.getElementById('vocab-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const word = formData.get('word')?.trim();
        if (!word) return;

        const payload = {
          word,
          translation: formData.get('translation')?.trim(),
          example: formData.get('example')?.trim(),
          language: formData.get('language') || null,
          session_id: sessionId,
        };

        try {
          const res = await auth.apiRequest('/api/vocab', {
            method: 'POST',
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          if (data.success) {
            e.target.reset();
            await loadVocab();
            showNotification('‚úÖ –°–ª–æ–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
          } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–ª–æ–≤–∞');
          }
        } catch (error) {
          console.error('Error adding word:', error);
          showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–ª–æ–≤–∞', 'error');
        }
      });
    }

    function showError(message) {
      document.body.innerHTML = `
        <div class="error-state" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
          <div>
            <h3>–û—à–∏–±–∫–∞</h3>
            <p>${message}</p>
            <button onclick="history.back()" class="btn-primary" style="margin-top: 1rem;">
              ‚Üê –ù–∞–∑–∞–¥
            </button>
          </div>
        </div>
      `;
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; 
        top: 20px; 
        right: 20px; 
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : 'var(--accent-color)'}; 
        color: white; 
        padding: 12px 20px; 
        border-radius: 8px; 
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-width: 300px;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é
      if (!document.getElementById('notificationStyles')) {
        const style = document.createElement('style');
        style.id = 'notificationStyles';
        style.textContent = `
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (document.body.contains(notification)) {
          notification.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }
      }, 3000);
    }

    console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Ä–æ–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
  </script>
</body>
</html>
