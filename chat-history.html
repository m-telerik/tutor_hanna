<div class="chat-container" id="chatContainer">
    <div class="loading">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –∏ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–∞–º—è—Ç–∏</p>
      <div style="font-size: 12px; opacity: 0.7; margin-top<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #202124;
      --border-color: #e0e0e0;
      --header-bg: #f1f3f4;
      --accent-color: #007aff;
      --card-bg: #f8f9fa;
      --ai-bg: #e3f2fd;
      --human-bg: #f3e5f5;
      --system-bg: #fff3e0;
      --ai-border: #2196f3;
      --human-border: #9c27b0;
      --system-border: #ff9800;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --text-color: #e1e1e1;
        --border-color: #333;
        --header-bg: #2d2d2d;
        --accent-color: #0a84ff;
        --card-bg: #2d2d2d;
        --ai-bg: #1e3a5f;
        --human-bg: #3d1a78;
        --system-bg: #5d4037;
        --ai-border: #64b5f6;
        --human-border: #ba68c8;
        --system-border: #ffb74d;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      font-size: 14px;
      margin: 0.5rem;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .header {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .session-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, input {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 14px;
    }

    .load-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .load-btn:hover {
      opacity: 0.9;
    }

    .chat-container {
      max-height: 70vh;
      overflow-y: auto;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border-color);
    }

    .message {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 12px;
      border-left: 4px solid;
      position: relative;
    }

    .message.ai {
      background: var(--ai-bg);
      border-left-color: var(--ai-border);
    }

    .message.human {
      background: var(--human-bg);
      border-left-color: var(--human-border);
    }

    .message.system {
      background: var(--system-bg);
      border-left-color: var(--system-border);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 12px;
      opacity: 0.8;
    }

    .message-type {
      font-weight: 600;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0,0,0,0.1);
    }

    .message-content {
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .tool-calls {
      margin-top: 1rem;
      padding: 0.5rem;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-color);
    }

    .error {
      color: #ff3b30;
      text-align: center;
      padding: 1rem;
      background: rgba(255, 59, 48, 0.1);
      border-radius: 6px;
      margin: 1rem 0;
    }

    .stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 12px;
      opacity: 0.7;
    }

    .filter-controls {
      margin-bottom: 1rem;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 4px 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .filter-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      padding: 0.5rem 0;
      font-size: 14px;
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .emoji {
      margin-right: 0.5rem;
    }

    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .session-selector {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="header">
    <h1><span class="emoji">üí¨</span>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h1>
    <div class="session-selector">
      <select id="studentSelect">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞...</option>
      </select>
      <select id="agentSelect">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞...</option>
        <option value="hanna_user">ü§ñ Main Agent (–æ—Å–Ω–æ–≤–Ω–æ–π)</option>
        <option value="student">üë§ Student Agent (—É—á–µ–Ω–∏–∫)</option>
        <option value="lead">üåü Lead Agent (–ª–∏–¥)</option>
      </select>
      <input type="text" id="customMemoryKey" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –ø–∞–º—è—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: student_71272569)" />
      <button class="load-btn" onclick="loadChatHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
  </div>

  <div class="filter-controls" id="filterControls" style="display: none;">
    <button class="filter-btn active" onclick="filterMessages('all')">–í—Å–µ</button>
    <button class="filter-btn" onclick="filterMessages('ai')">AI</button>
    <button class="filter-btn" onclick="filterMessages('human')">Human</button>
    <button class="filter-btn" onclick="filterMessages('system')">System</button>
  </div>

  <div class="stats" id="stats" style="display: none;"></div>

  <div class="chat-container" id="chatContainer">
    <div class="loading">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –∏ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–∞–º—è—Ç–∏</p>
      <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
        <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
        ‚Ä¢ –ö–ª—é—á –ø–∞–º—è—Ç–∏ = —Ç–∏–ø_–∞–≥–µ–Ω—Ç–∞_telegram_id<br>
        ‚Ä¢ –ù–∞–ø—Ä–∏–º–µ—Ä: student_71272569, hanna_user_71272569, lead_937619983
      </div>
    </div>
  </div>

  <script>
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 618647337;
    let allMessages = [];
    let currentFilter = 'all';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      loadAvailableStudents();
    });

    async function loadAvailableStudents() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId }
        });
        
        if (!response.ok) throw new Error('Failed to load students');
        
        const { students } = await response.json();
        const studentSelect = document.getElementById('studentSelect');
        
        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
        studentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞...</option>';
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã
        students.forEach(student => {
          const option = document.createElement('option');
          // –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å telegram_id –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∫–∞–∫ placeholder
          option.value = student.telegram_id || student.name.toLowerCase().replace(/\s+/g, '');
          option.textContent = student.name;
          option.dataset.telegramId = student.telegram_id || '';
          studentSelect.appendChild(option);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Å telegram_id
        const knownStudents = [
          { telegram_id: '71272569', name: '–ö—Ä–∏—Å' },
          { telegram_id: '937619983', name: '–ü—Ä–∏–º–µ—Ä –ª–∏–¥–∞' },
          { telegram_id: '123456789', name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }
        ];

        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = '--- –ü—Ä–∏–º–µ—Ä—ã ---';
        studentSelect.appendChild(separator);

        knownStudents.forEach(student => {
          const option = document.createElement('option');
          option.value = student.telegram_id;
          option.textContent = `${student.name} (${student.telegram_id})`;
          option.dataset.telegramId = student.telegram_id;
          studentSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading students:', error);
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
        const studentSelect = document.getElementById('studentSelect');
        studentSelect.innerHTML = `
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞...</option>
          <option value="71272569" data-telegram-id="71272569">–ö—Ä–∏—Å (71272569)</option>
          <option value="937619983" data-telegram-id="937619983">–ü—Ä–∏–º–µ—Ä –ª–∏–¥–∞ (937619983)</option>
          <option value="123456789" data-telegram-id="123456789">–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (123456789)</option>
        `;
      }
    }

    async function loadChatHistory() {
      const studentSelect = document.getElementById('studentSelect');
      const agentSelect = document.getElementById('agentSelect');
      const customMemoryKey = document.getElementById('customMemoryKey');
      
      let memoryKey;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–≤–µ–ª–∏ –ª–∏ –∫–ª—é—á –ø–∞–º—è—Ç–∏ –Ω–∞–ø—Ä—è–º—É—é
      if (customMemoryKey.value.trim()) {
        memoryKey = customMemoryKey.value.trim();
      } else {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –ø–∞–º—è—Ç–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        const studentId = studentSelect.value;
        const agentType = agentSelect.value;
        
        if (!studentId || !agentType) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –∏ –∞–≥–µ–Ω—Ç–∞, –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –ø–∞–º—è—Ç–∏ –Ω–∞–ø—Ä—è–º—É—é');
          return;
        }
        
        memoryKey = `${agentType}_${studentId}`;
      }

      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞...</div>';

      try {
        // –ó–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –ø–æ –∫–ª—é—á—É –ø–∞–º—è—Ç–∏
        const response = await fetch(`/api/chat-history?memory_key=${encodeURIComponent(memoryKey)}`, {
          headers: { "x-telegram-id": userId }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const { messages } = await response.json();
        
        if (!messages || messages.length === 0) {
          // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ API, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
          allMessages = await getMockChatData(memoryKey);
        } else {
          allMessages = messages;
        }
        
        renderMessages();
        updateStats();
        
        document.getElementById('filterControls').style.display = 'flex';
        document.getElementById('stats').style.display = 'flex';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º –∫–ª—é—á–µ –ø–∞–º—è—Ç–∏
        updateMemoryKeyInfo(memoryKey);
        
      } catch (error) {
        console.error('Error loading chat history:', error);
        
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ API –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        console.log('Falling back to mock data...');
        try {
          allMessages = await getMockChatData(memoryKey);
          renderMessages();
          updateStats();
          document.getElementById('filterControls').style.display = 'flex';
          document.getElementById('stats').style.display = 'flex';
          updateMemoryKeyInfo(memoryKey + ' (–¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ)');
        } catch (mockError) {
          chatContainer.innerHTML = 
            '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞: ' + error.message + '</div>';
        }
      }
    }

    function updateMemoryKeyInfo(memoryKey) {
      const [agentType, telegramId] = memoryKey.split('_');
      const agentNames = {
        'hanna_user': 'ü§ñ Main Agent (–æ—Å–Ω–æ–≤–Ω–æ–π)',
        'student': 'üë§ Student Agent (—É—á–µ–Ω–∏–∫)', 
        'lead': 'üåü Lead Agent (–ª–∏–¥)'
      };
      
      const agentName = agentNames[agentType] || '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≥–µ–Ω—Ç';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –∫–ª—é—á–µ –ø–∞–º—è—Ç–∏
      const existingInfo = document.querySelector('.memory-key-info');
      if (existingInfo) existingInfo.remove();
      
      const memoryKeyInfo = document.createElement('div');
      memoryKeyInfo.className = 'memory-key-info';
      memoryKeyInfo.style.cssText = `
        background: var(--card-bg);
        border-radius: 6px;
        padding: 0.8rem;
        margin: 1rem 0;
        border: 1px solid var(--border-color);
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      `;
      memoryKeyInfo.innerHTML = `
        <span><strong>–ö–ª—é—á –ø–∞–º—è—Ç–∏:</strong> <code style="background: var(--bg-color); padding: 2px 6px; border-radius: 4px; font-family: monospace;">${memoryKey}</code></span>
        <span><strong>–ê–≥–µ–Ω—Ç:</strong> ${agentName}</span>
        <span><strong>Telegram ID:</strong> ${telegramId || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
      `;
      
      const filterControls = document.getElementById('filterControls');
      filterControls.parentNode.insertBefore(memoryKeyInfo, filterControls);
    }

    // –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ –∫–ª—é—á–∞–º –ø–∞–º—è—Ç–∏
    async function getMockChatData(memoryKey) {
      // –ò–º–∏—Ç–∞—Ü–∏—è API –∑–∞–ø—Ä–æ—Å–∞
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const [agentType, telegramId] = memoryKey.split('_');
      
      if (memoryKey === 'student_71272569') {
        return [
          {
            id: 33,
            session_id: "student_71272569",
            message: JSON.stringify({
              type: "human",
              content: "–ü—Ä–∏–≤–µ—Ç! –ú–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ 'ringard' –≤ –º–æ–π —Å–ª–æ–≤–∞—Ä—å?",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 34,
            session_id: "student_71272569", 
            message: JSON.stringify({
              type: "ai",
              content: "–ì–æ—Ç–æ–≤–æ, –ö—Ä–∏—Å ‚Äî —è –¥–æ–±–∞–≤–∏–ª–∞ —Å–ª–æ–≤–æ ringard / ringarde –≤ —Ç–≤–æ–π —Å–ª–æ–≤–∞—Ä—å. \n\n–í–æ—Ç —á—Ç–æ —è —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞:\n- ringard / ringarde ‚Äî —Ñ—Ä–∞–Ω—Ü. (—Ä–∞–∑–≥.)\n- –ó–Ω–∞—á–µ–Ω–∏–µ: —Å—Ç–∞—Ä–æ–º–æ–¥–Ω—ã–π, –Ω–µ–º–æ–¥–Ω—ã–π, –±–µ–∑–≤–∫—É—Å–Ω—ã–π; ¬´–Ω–µ–∫—Ä—É—Ç–æ–π¬ª\n- –ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ: [ Å…õÃÉ…°a Å] (–ø—Ä–∏–º–µ—Ä–Ω–æ ¬´—Ä—ç–Ω-–≥–∞—Ä¬ª), ringarde ‚Äî [ Å…õÃÉ…°a Åd]\n- –°–∏–Ω–æ–Ω–∏–º—ã: d√©mod√©, d√©pass√©, vieillot, kitsch\n- –ü—Ä–∏–º–µ—Ä—ã: Ce pull est un peu ringard. / Ne sois pas ringard ! / Il fait des blagues ringardes.\n- session_id –Ω–µ —É–∫–∞–∑–∞–Ω\n\n–•–æ—á–µ—à—å, —è —Å–æ—Å—Ç–∞–≤–ª—é –ø–∞—Ä—É –∫–æ—Ä–æ—Ç–∫–∏—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π/–¥–∏–∞–ª–æ–≥–æ–≤ —Å —ç—Ç–∏–º —Å–ª–æ–≤–æ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—é –µ—â—ë 2-3 –ø–æ—Ö–æ–∂–∏—Ö —Å–ª–æ–≤–∞ –≤ —Å–ª–æ–≤–∞—Ä—å?",
              tool_calls: [],
              additional_kwargs: {},
              response_metadata: {},
              invalid_tool_calls: []
            })
          },
          {
            id: 35,
            session_id: "student_71272569",
            message: JSON.stringify({
              type: "human", 
              content: "–î–∞, —Å–æ—Å—Ç–∞–≤—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å —ç—Ç–∏–º —Å–ª–æ–≤–æ–º!",
              additional_kwargs: {},
              response_metadata: {}
            })
          }
        ];
      }
      
      if (memoryKey === 'hanna_user_71272569') {
        return [
          {
            id: 1,
            session_id: "hanna_user_71272569",
            message: JSON.stringify({
              type: "system",
              content: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Main Agent –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 71272569",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 2,
            session_id: "hanna_user_71272569",
            message: JSON.stringify({
              type: "human",
              content: "–ü—Ä–∏–≤–µ—Ç –•–∞–Ω–Ω–∞! –ö–∞–∫ –¥–µ–ª–∞?",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 3,
            session_id: "hanna_user_71272569", 
            message: JSON.stringify({
              type: "ai",
              content: "–ü—Ä–∏–≤–µ—Ç! –£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å —Å –∏–∑—É—á–µ–Ω–∏–µ–º —è–∑—ã–∫–æ–≤. –£ —Ç–µ–±—è –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–º—É –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É?",
              tool_calls: [],
              additional_kwargs: {},
              response_metadata: {}
            })
          }
        ];
      }
      
      if (memoryKey === 'lead_937619983') {
        return [
          {
            id: 1,
            session_id: "lead_937619983",
            message: JSON.stringify({
              type: "system",
              content: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Lead Agent –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ 937619983",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 2,
            session_id: "lead_937619983",
            message: JSON.stringify({
              type: "human",
              content: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É —É–∑–Ω–∞—Ç—å –ø—Ä–æ —É—Ä–æ–∫–∏ —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 3,
            session_id: "lead_937619983",
            message: JSON.stringify({
              type: "ai",
              content: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –†–∞–¥–∞, —á—Ç–æ –≤—ã –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏—Å—å –∏–∑—É—á–µ–Ω–∏–µ–º —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ! –•–∞–Ω–Ω–∞ - —Å–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å CELTA Grade A —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º.\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ:\n- –ö–∞–∫–æ–π —É –≤–∞—Å —É—Ä–æ–≤–µ–Ω—å —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ —Å–µ–π—á–∞—Å?\n- –ö–∞–∫–∏–µ —Ü–µ–ª–∏ —Ö–æ—Ç–∏—Ç–µ –¥–æ—Å—Ç–∏—á—å?\n- –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –≥–æ—Ç–æ–≤—ã —É–¥–µ–ª—è—Ç—å –∑–∞–Ω—è—Ç–∏—è–º –≤ –Ω–µ–¥–µ–ª—é?\n\n–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –º–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –æ–±—É—á–µ–Ω–∏—è!",
              tool_calls: [],
              additional_kwargs: {},
              response_metadata: {}
            })
          }
        ];
      }
      
      // –î–ª—è –¥—Ä—É–≥–∏—Ö –∫–ª—é—á–µ–π –ø–∞–º—è—Ç–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      return [
        {
          id: 1,
          session_id: memoryKey,
          message: JSON.stringify({
            type: "system",
            content: `–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ —Å –∫–ª—é—á–æ–º –ø–∞–º—è—Ç–∏: ${memoryKey}`,
            additional_kwargs: {},
            response_metadata: {}
          })
        },
        {
          id: 2, 
          session_id: memoryKey,
          message: JSON.stringify({
            type: "ai",
            content: `–ü—Ä–∏–≤–µ—Ç! –Ø ${agentType === 'hanna_user' ? 'Main Agent –•–∞–Ω–Ω—ã' : agentType === 'student' ? 'Student Agent' : agentType === 'lead' ? 'Lead Agent' : '–∞–≥–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã'}. Telegram ID: ${telegramId}`,
            tool_calls: [],
            additional_kwargs: {},
            response_metadata: {}
          })
        }
      ];
    }

    function renderMessages() {
      const container = document.getElementById('chatContainer');
      
      const filteredMessages = currentFilter === 'all' 
        ? allMessages 
        : allMessages.filter(msg => {
            try {
              const parsed = JSON.parse(msg.message);
              return parsed.type === currentFilter;
            } catch {
              return false;
            }
          });

      if (filteredMessages.length === 0) {
        container.innerHTML = '<div class="loading">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
        return;
      }

      container.innerHTML = filteredMessages.map(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          const timestamp = new Date().toLocaleString('ru-RU'); // –ï—Å–ª–∏ –µ—Å—Ç—å timestamp –≤ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ
          
          return `
            <div class="message ${parsed.type}">
              <div class="message-header">
                <span class="message-type">${getTypeEmoji(parsed.type)} ${parsed.type}</span>
                <span>ID: ${msg.id} | ${timestamp}</span>
              </div>
              <div class="message-content">${escapeHtml(parsed.content)}</div>
              ${parsed.tool_calls && parsed.tool_calls.length > 0 ? `
                <div class="tool-calls">
                  <strong>Tool calls:</strong> ${JSON.stringify(parsed.tool_calls, null, 2)}
                </div>
              ` : ''}
              ${parsed.invalid_tool_calls && parsed.invalid_tool_calls.length > 0 ? `
                <div class="tool-calls">
                  <strong>Invalid tool calls:</strong> ${JSON.stringify(parsed.invalid_tool_calls, null, 2)}
                </div>
              ` : ''}
            </div>
          `;
        } catch (error) {
          return `
            <div class="message system">
              <div class="message-header">
                <span class="message-type">‚ö†Ô∏è ERROR</span>
                <span>ID: ${msg.id}</span>
              </div>
              <div class="message-content">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${escapeHtml(msg.message)}</div>
            </div>
          `;
        }
      }).join('');
    }

    function filterMessages(type) {
      currentFilter = type;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderMessages();
      updateStats();
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const typeCounts = { ai: 0, human: 0, system: 0, error: 0 };
      
      allMessages.forEach(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          typeCounts[parsed.type] = (typeCounts[parsed.type] || 0) + 1;
        } catch {
          typeCounts.error++;
        }
      });
      
      stats.innerHTML = `
        <span>–í—Å–µ–≥–æ: ${allMessages.length}</span>
        <span>AI: ${typeCounts.ai}</span>
        <span>Human: ${typeCounts.human}</span>
        <span>System: ${typeCounts.system}</span>
        ${typeCounts.error > 0 ? `<span>–û—à–∏–±–∫–∏: ${typeCounts.error}</span>` : ''}
      `;
    }

    function getTypeEmoji(type) {
      const emojis = {
        ai: 'ü§ñ',
        human: 'üë§', 
        system: '‚öôÔ∏è',
        assistant: 'ü§ñ',
        user: 'üë§'
      };
      return emojis[type] || '‚ùì';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∫–ª—é—á–∞ –ø–∞–º—è—Ç–∏
    document.getElementById('customMemoryKey').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadChatHistory();
      }
    });
  </script>
</body>
</html>
