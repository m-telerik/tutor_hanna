<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–ª–æ–≤–∞—Ä—å —Å—Ç—É–¥–µ–Ω—Ç–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/vocabulary.css">
</head>
<body>
  <div class="page-content">
    <div class="header">
      <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
      <h1><span class="emoji">üìö</span>–°–ª–æ–≤–∞—Ä—å</h1>
      <div></div>
    </div>

    <div class="stats-grid" id="stats">
      <div class="stat-card">
        <div class="stat-number" id="total-words">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ —Å–ª–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="english-words">0</div>
        <div class="stat-label">English</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="french-words">0</div>
        <div class="stat-label">French</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="studied-words">0</div>
        <div class="stat-label">–ò–∑—É—á–µ–Ω–æ</div>
      </div>
    </div>

    <div class="filters">
      <input type="text" class="search-box" id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞–º..." />
      <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
      <button class="filter-btn" data-filter="english">English</button>
      <button class="filter-btn" data-filter="french">French</button>
      <button class="filter-btn" data-filter="studied">–ò–∑—É—á–µ–Ω–æ</button>
      <button class="filter-btn" data-filter="new">–ù–æ–≤—ã–µ</button>
    </div>

    <div class="vocab-list">
      <div class="table-container">
        <table id="vocab-table">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞ —É—Ä–æ–∫–∞</th>
              <th>–°–ª–æ–≤–æ</th>
              <th>–ü–µ—Ä–µ–≤–æ–¥</th>
              <th>–ü—Ä–∏–º–µ—Ä</th>
              <th>–Ø–∑—ã–∫</th>
              <th>–ò–∑—É—á–µ–Ω–æ</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="vocab-tbody">
            <tr>
              <td colspan="7" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const userId = new URLSearchParams(window.location.search).get("user_id");
    const telegramUserId = Telegram.WebApp.initDataUnsafe?.user?.id;
    const vocabTbody = document.getElementById("vocab-tbody");
    const searchInput = document.getElementById("search");
    
    let allWords = [];
    let filteredWords = [];
    let currentFilter = 'all';

    if (!userId) {
      vocabTbody.innerHTML = '<tr><td colspan="7" class="error">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
    } else {
      document.querySelector('h1').innerHTML = `<span class="emoji">üìö</span>–°–ª–æ–≤–∞—Ä—å —Å—Ç—É–¥–µ–Ω—Ç–∞`;
      loadVocabulary();
    }

    async function loadVocabulary() {
      try {
        const res = await fetch(`/api/vocab?user_id=${encodeURIComponent(userId)}`, {
          headers: { "x-telegram-id": telegramUserId || userId }
        });
        const { words = [] } = await res.json();
        
        allWords = words;
        updateStats();
        applyFilters();
      } catch (error) {
        console.error('Error loading vocabulary:', error);
        vocabTbody.innerHTML = '<tr><td colspan="7" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è</td></tr>';
      }
    }

    function updateStats() {
      const englishWords = allWords.filter(w => w.language === 'english');
      const frenchWords = allWords.filter(w => w.language === 'french');
      const studiedWords = allWords.filter(w => w.studied_count > 0);

      document.getElementById('total-words').textContent = allWords.length;
      document.getElementById('english-words').textContent = englishWords.length;
      document.getElementById('french-words').textContent = frenchWords.length;
      document.getElementById('studied-words').textContent = studiedWords.length;
    }

    function applyFilters() {
      let filtered = [...allWords];
      
      // –§–∏–ª—å—Ç—Ä –ø–æ —è–∑—ã–∫—É –∏ —Å—Ç–∞—Ç—É—Å—É
      if (currentFilter === 'english') {
        filtered = filtered.filter(w => w.language === 'english');
      } else if (currentFilter === 'french') {
        filtered = filtered.filter(w => w.language === 'french');
      } else if (currentFilter === 'studied') {
        filtered = filtered.filter(w => w.studied_count > 0);
      } else if (currentFilter === 'new') {
        filtered = filtered.filter(w => w.studied_count === 0);
      }

      // –ü–æ–∏—Å–∫
      const searchTerm = searchInput.value.toLowerCase().trim();
      if (searchTerm) {
        filtered = filtered.filter(w => 
          w.word.toLowerCase().includes(searchTerm) ||
          (w.translation && w.translation.toLowerCase().includes(searchTerm)) ||
          (w.example && w.example.toLowerCase().includes(searchTerm))
        );
      }

      filteredWords = filtered;
      renderTable();
    }

    function renderTable() {
      if (filteredWords.length === 0) {
        vocabTbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <div class="emoji">üîç</div>
              <p>–°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            </td>
          </tr>
        `;
        return;
      }

      vocabTbody.innerHTML = filteredWords.map(w => `
        <tr class="word-row ${w.studied_count > 0 ? 'studied' : ''}">
          <td>${w.session_date ? new Date(w.session_date).toLocaleDateString('ru-RU') : '‚Äî'}</td>
          <td><strong>${w.word}</strong></td>
          <td>${w.translation || ''}</td>
          <td>${w.example || ''}</td>
          <td>
            ${w.language ? `<span class="language-badge ${w.language}">${w.language}</span>` : '‚Äî'}
          </td>
          <td>
            ${w.studied_count > 0 ? `<span style="color: var(--success-color);">${w.studied_count}x</span>` : '‚Äî'}
          </td>
          <td>
            <div class="word-actions">
              <button class="action-btn ${w.studied_count > 0 ? 'studied' : ''}" 
                      onclick="markStudied('${w.id}')">
                ${w.studied_count > 0 ? '‚úì' : '–ò–∑—É—á–∏—Ç—å'}
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function markStudied(wordId) {
      try {
        const res = await fetch('/api/vocab', {
          method: 'PUT',
          headers: {
            "Content-Type": "application/json",
            "x-telegram-id": telegramUserId || userId
          },
          body: JSON.stringify({ id: wordId, studied: true })
        });

        if (res.ok) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          const word = allWords.find(w => w.id === wordId);
          if (word) {
            word.studied_count = (word.studied_count || 0) + 1;
            word.last_studied_at = new Date().toISOString();
          }
          
          updateStats();
          applyFilters();
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–ª–æ–≤–∞');
        }
      } catch (error) {
        console.error('Error marking word as studied:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–ª–æ–≤–∞');
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    searchInput.addEventListener('input', applyFilters);

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        applyFilters();
      });
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  </script>
</body>
</html>
