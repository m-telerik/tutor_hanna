<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hanna English & French</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="js/auth.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    :root{
      --accent-color:#3b82f6;
      --text-color:#e5e7eb;
      --bg-color:#0f1115;
    }
    html,body{margin:0;background:var(--bg-color);color:var(--text-color);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;text-align:center}
    .spinner{width:50px;height:50px;border:3px solid var(--accent-color);border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    h1{margin:0 0 8px;font-size:18px;color:var(--accent-color)}
    p{margin:0;opacity:.8}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn{
      margin-top:18px;display:inline-block;padding:10px 14px;border-radius:10px;
      background:var(--accent-color);color:#fff;text-decoration:none;font-weight:600
    }
  </style>
</head>
<body>
  <div class="wrap" id="loadingScreen">
    <div>
      <div class="spinner"></div>
      <h1>Hanna English & French</h1>
      <p id="loadingText">Определяем вашу роль…</p>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    // Безопасный редирект в бронирование
    function goBooking() {
      window.location.replace('booking.html');
    }

    // Показ понятного экрана, если открыто вне Telegram
    function showOpenInTelegram() {
      const box = document.getElementById('loadingScreen');
      box.innerHTML = `
        <div>
          <h1>Откройте мини‑приложение в Telegram</h1>
          <p>Эта страница работает только внутри Telegram WebApp.</p>
          <a class="btn" href="https://t.me/tutor_hanna_bot">Открыть бота</a>
        </div>
      `;
    }

    // Основной сценарий
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (!tg || !tg.initDataUnsafe?.user) {
          // Нет Telegram — показываем кнопку
          showOpenInTelegram();
          return;
        }

        tg.ready();
        tg.expand();

        // Инициализируем авторизацию: допускаем admin, tutor, student, prospect
        const auth = new AuthSystem();

        // Встроенная обработка успеха/ошибки
        await auth.init(['admin', 'tutor', 'student', 'prospect'], onAuthSuccess, onAuthFail);

        // На всякий случай таймаут‑фолбэк от вечной загрузки
        setTimeout(() => {
          const txt = document.getElementById('loadingText')?.textContent || '';
          if (txt.includes('Определяем вашу роль')) {
            goBooking();
          }
        }, 7000);

      } catch (e) {
        // Любая ошибка — уводим на бронирование
        goBooking();
      }
    });

    // Если авторизация успешна — роутим по роли
    function onAuthSuccess(user) {
      try {
        switch (user.role) {
          case 'admin':
            window.location.replace('admin.html');
            break;
          case 'tutor':
            window.location.replace('tutor.html');
            break;
          case 'student':
            // Если знаем конкретного пользователя — можно вести в профиль; иначе на бронирование
            if (user.user_id || user.id) {
              const id = encodeURIComponent(user.user_id || user.id);
              window.location.replace(`student.html?user_id=${id}`);
            } else {
              goBooking();
            }
            break;
          case 'prospect':
          default:
            // Все неизвестные роли — в бронирование
            goBooking();
        }
      } catch {
        goBooking();
      }
    }

    // Если авторизация провалилась (нет в базе/нет роли) — сразу бронирование
    function onAuthFail(error) {
      // Можно сузить по текстам, но бизнес‑логика простая: любой фейл тут = бронирование
      goBooking();
    }
  </script>
</body>
</html>
