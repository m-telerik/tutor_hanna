<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #202124;
      --border-color: #e0e0e0;
      --header-bg: #f1f3f4;
      --accent-color: #007aff;
      --card-bg: #f8f9fa;
      --ai-bg: #e3f2fd;
      --human-bg: #f3e5f5;
      --system-bg: #fff3e0;
      --ai-border: #2196f3;
      --human-border: #9c27b0;
      --system-border: #ff9800;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --text-color: #e1e1e1;
        --border-color: #333;
        --header-bg: #2d2d2d;
        --accent-color: #0a84ff;
        --card-bg: #2d2d2d;
        --ai-bg: #1e3a5f;
        --human-bg: #3d1a78;
        --system-bg: #5d4037;
        --ai-border: #64b5f6;
        --human-border: #ba68c8;
        --system-border: #ffb74d;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      font-size: 14px;
      margin: 0.5rem;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .header {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border-color);
    }

    .navigation-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .step {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .step-label {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-color);
      opacity: 0.8;
    }

    .step-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, input {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 14px;
      min-width: 180px;
    }

    select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .load-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: opacity 0.2s;
    }

    .load-btn:hover {
      opacity: 0.9;
    }

    .load-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .chat-list {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      border: 1px solid var(--border-color);
      max-height: 300px;
      overflow-y: auto;
    }

    .chat-item {
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 8px;
      border: 1px solid var(--border-color);
    }

    .chat-item:hover {
      background: var(--accent-color);
      color: white;
    }

    .chat-item.selected {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .chat-item-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .chat-item-meta {
      font-size: 12px;
      opacity: 0.8;
    }

    .chat-container {
      max-height: 60vh;
      overflow-y: auto;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border-color);
    }

    .message {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 12px;
      border-left: 4px solid;
      position: relative;
    }

    .message.ai {
      background: var(--ai-bg);
      border-left-color: var(--ai-border);
    }

    .message.human {
      background: var(--human-bg);
      border-left-color: var(--human-border);
    }

    .message.system {
      background: var(--system-bg);
      border-left-color: var(--system-border);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 12px;
      opacity: 0.8;
    }

    .message-type {
      font-weight: 600;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0,0,0,0.1);
    }

    .message-content {
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .tool-calls {
      margin-top: 1rem;
      padding: 0.5rem;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-color);
    }

    .error {
      color: #ff3b30;
      text-align: center;
      padding: 1rem;
      background: rgba(255, 59, 48, 0.1);
      border-radius: 6px;
      margin: 1rem 0;
    }

    .stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 12px;
      opacity: 0.7;
    }

    .filter-controls {
      margin-bottom: 1rem;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 4px 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .filter-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      padding: 0.5rem 0;
      font-size: 14px;
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .emoji {
      margin-right: 0.5rem;
    }

    .memory-key-info {
      background: var(--card-bg);
      border-radius: 6px;
      padding: 0.8rem;
      margin: 1rem 0;
      border: 1px solid var(--border-color);
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    @media (max-width: 600px) {
      .step-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      select, input {
        min-width: auto;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="header">
    <h1><span class="emoji">üí¨</span>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h1>
    
    <div class="navigation-panel">
      <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä –∞–≥–µ–Ω—Ç–∞ -->
      <div class="step">
        <div class="step-label">1. –í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞:</div>
        <div class="step-controls">
          <select id="agentSelect" onchange="onAgentChange()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞...</option>
            <option value="hanna_user">ü§ñ TutorBot (–æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç)</option>
            <option value="student">üë§ Student Agent (–¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)</option>
            <option value="lead">üåü Lead Agent (–¥–ª—è –ª–∏–¥–æ–≤)</option>
          </select>
        </div>
      </div>

      <!-- –®–∞–≥ 2: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–≥–µ–Ω—Ç–∞) -->
      <div class="step" id="step2" style="display: none;">
        <div class="step-label" id="step2Label"></div>
        <div class="step-controls">
          <select id="filterSelect" onchange="onFilterChange()" disabled>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
          </select>
          <button class="load-btn" onclick="loadChatList()" disabled id="loadListBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>
      </div>

      <!-- –®–∞–≥ 3: –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ (–¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤) -->
      <div class="step" id="step3" style="display: none;">
        <div class="step-label" id="step3Label">3. –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç:</div>
        <div class="step-controls">
          <button class="load-btn" onclick="loadChatHistory()" disabled id="loadChatBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞) -->
  <div class="chat-list" id="chatList" style="display: none;">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤...</div>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π -->
  <div class="filter-controls" id="filterControls" style="display: none;">
    <button class="filter-btn active" onclick="filterMessages('all')">–í—Å–µ</button>
    <button class="filter-btn" onclick="filterMessages('ai')">AI</button>
    <button class="filter-btn" onclick="filterMessages('human')">Human</button>
    <button class="filter-btn" onclick="filterMessages('system')">System</button>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats" id="stats" style="display: none;"></div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ -->
  <div class="chat-container" id="chatContainer">
    <div class="loading">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
      <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
        <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã:</strong><br>
        ‚Ä¢ ü§ñ TutorBot - –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
        ‚Ä¢ üë§ Student Agent - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤<br>
        ‚Ä¢ üåü Lead Agent - –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
      </div>
    </div>
  </div>

  <script>
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 618647337;
    let allMessages = [];
    let currentFilter = 'all';
    let selectedChatKey = null;
    let availableStudents = [];
    let availableChats = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      loadAvailableStudents();
    });

    async function loadAvailableStudents() {
      try {
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId }
        });
        
        if (response.ok) {
          const { students } = await response.json();
          availableStudents = students;
        }
      } catch (error) {
        console.error('Error loading students:', error);
      }
    }

    function onAgentChange() {
      const agentSelect = document.getElementById('agentSelect');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const filterSelect = document.getElementById('filterSelect');
      const step2Label = document.getElementById('step2Label');
      const loadListBtn = document.getElementById('loadListBtn');
      
      // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
      resetChatInterface();
      
      const selectedAgent = agentSelect.value;
      
      if (!selectedAgent) {
        step2.style.display = 'none';
        step3.style.display = 'none';
        return;
      }

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ —à–∞–≥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–≥–µ–Ω—Ç–∞
      if (selectedAgent === 'hanna_user') {
        // –î–ª—è TutorBot –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å—Ä–∞–∑—É, –≤—Ç–æ—Ä–æ–π —à–∞–≥ –Ω–µ –Ω—É–∂–µ–Ω
        step2.style.display = 'none';
        step3.style.display = 'none';
        loadTutorBotHistory();
        
      } else if (selectedAgent === 'student') {
        // –î–ª—è Student Agent –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        step2Label.textContent = '2. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞:';
        populateStudentFilter();
        step2.style.display = 'block';
        step3.style.display = 'none';
        
      } else if (selectedAgent === 'lead') {
        // –î–ª—è Lead Agent –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –ª–∏–¥–æ–≤
        step2Label.textContent = '2. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –ª–∏–¥–∞:';
        populateLeadStatusFilter();
        step2.style.display = 'block';
        step3.style.display = 'none';
      }
    }

    function populateStudentFilter() {
      const filterSelect = document.getElementById('filterSelect');
      const loadListBtn = document.getElementById('loadListBtn');
      
      filterSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞...</option>';
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã
      availableStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.telegram_id || student.name.toLowerCase().replace(/\s+/g, '');
        option.textContent = student.name;
        option.dataset.telegramId = student.telegram_id || '';
        filterSelect.appendChild(option);
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
      const knownStudents = [
        { telegram_id: '71272569', name: '–ö—Ä–∏—Å (–ø—Ä–∏–º–µ—Ä)' },
        { telegram_id: '123456789', name: '–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ç—É–¥–µ–Ω—Ç' }
      ];
      
      if (knownStudents.length > 0) {
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = '--- –ü—Ä–∏–º–µ—Ä—ã ---';
        filterSelect.appendChild(separator);
        
        knownStudents.forEach(student => {
          const option = document.createElement('option');
          option.value = student.telegram_id;
          option.textContent = student.name;
          option.dataset.telegramId = student.telegram_id;
          filterSelect.appendChild(option);
        });
      }
      
      filterSelect.disabled = false;
      loadListBtn.disabled = true;
    }

    function populateLeadStatusFilter() {
      const filterSelect = document.getElementById('filterSelect');
      const loadListBtn = document.getElementById('loadListBtn');
      
      filterSelect.innerHTML = `
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...</option>
        <option value="new">üÜï –ù–æ–≤—ã–µ –ª–∏–¥—ã</option>
        <option value="contacted">üìû –°–≤—è–∑–∞–ª–∏—Å—å</option>
        <option value="interested">üí´ –ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã</option>
        <option value="trial">üéØ –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫</option>
        <option value="converted">‚úÖ –°—Ç–∞–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</option>
        <option value="lost">‚ùå –ü–æ—Ç–µ—Ä—è–Ω—ã</option>
        <option value="all">üìã –í—Å–µ –ª–∏–¥—ã</option>
      `;
      
      filterSelect.disabled = false;
      loadListBtn.disabled = true;
    }

    function onFilterChange() {
      const filterSelect = document.getElementById('filterSelect');
      const loadListBtn = document.getElementById('loadListBtn');
      
      loadListBtn.disabled = !filterSelect.value;
    }

    async function loadTutorBotHistory() {
      // –î–ª—è TutorBot –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â—É—é –∏—Å—Ç–æ—Ä–∏—é
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ TutorBot...</div>';

      try {
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â—É—é –∏—Å—Ç–æ—Ä–∏—é TutorBot
        const memoryKey = `hanna_user_${userId}`;
        await loadChatHistoryByKey(memoryKey);
        
        showMemoryKeyInfo(memoryKey);
        
      } catch (error) {
        console.error('Error loading TutorBot history:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ
        allMessages = await getMockChatData(`hanna_user_${userId}`);
        renderMessages();
        updateStats();
        showFiltersAndStats();
        showMemoryKeyInfo(`hanna_user_${userId} (–¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ)`);
      }
    }

    async function loadChatList() {
      const agentSelect = document.getElementById('agentSelect');
      const filterSelect = document.getElementById('filterSelect');
      const chatList = document.getElementById('chatList');
      const step3 = document.getElementById('step3');
      const step3Label = document.getElementById('step3Label');
      
      const agent = agentSelect.value;
      const filter = filterSelect.value;
      
      if (!agent || !filter) return;
      
      chatList.style.display = 'block';
      chatList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤...</div>';
      
      try {
        if (agent === 'student') {
          // –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç—ã —Å –∞–≥–µ–Ω—Ç–∞–º–∏
          const studentId = filter;
          const chats = await getStudentChats(studentId);
          
          if (chats.length === 0) {
            chatList.innerHTML = '<div class="loading">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞</div>';
            return;
          }
          
          chatList.innerHTML = chats.map(chat => `
            <div class="chat-item" onclick="selectChat('${chat.key}')">
              <div class="chat-item-title">${chat.title}</div>
              <div class="chat-item-meta">${chat.description}</div>
            </div>
          `).join('');
          
          step3Label.textContent = '3. –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:';
          step3.style.display = 'block';
          
        } else if (agent === 'lead') {
          // –î–ª—è –ª–∏–¥–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ª–∏–¥–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É
          const status = filter;
          const leads = await getLeadsByStatus(status);
          
          if (leads.length === 0) {
            chatList.innerHTML = '<div class="loading">–ù–µ—Ç –ª–∏–¥–æ–≤ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º</div>';
            return;
          }
          
          chatList.innerHTML = leads.map(lead => `
            <div class="chat-item" onclick="selectChat('${lead.key}')">
              <div class="chat-item-title">${lead.title}</div>
              <div class="chat-item-meta">${lead.description}</div>
            </div>
          `).join('');
          
          step3Label.textContent = '3. –í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–¥–∞:';
          step3.style.display = 'block';
        }
        
      } catch (error) {
        console.error('Error loading chat list:', error);
        chatList.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤</div>';
      }
    }

    function selectChat(chatKey) {
      // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Ç
      event.target.closest('.chat-item').classList.add('selected');
      
      selectedChatKey = chatKey;
      document.getElementById('loadChatBtn').disabled = false;
    }

    async function loadChatHistory() {
      if (!selectedChatKey) return;
      
      await loadChatHistoryByKey(selectedChatKey);
      showMemoryKeyInfo(selectedChatKey);
    }

    async function loadChatHistoryByKey(memoryKey) {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞...</div>';

      try {
        const response = await fetch(`/api/chat-history?memory_key=${encodeURIComponent(memoryKey)}`, {
          headers: { "x-telegram-id": userId }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const { messages } = await response.json();
        
        if (!messages || messages.length === 0) {
          allMessages = await getMockChatData(memoryKey);
        } else {
          allMessages = messages;
        }
        
        renderMessages();
        updateStats();
        showFiltersAndStats();
        
      } catch (error) {
        console.error('Error loading chat history:', error);
        allMessages = await getMockChatData(memoryKey);
        renderMessages();
        updateStats();
        showFiltersAndStats();
      }
    }

    async function getStudentChats(studentId) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —á–∞—Ç—ã –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞
      return [
        {
          key: `student_${studentId}`,
          title: 'Student Agent Chat',
          description: '–û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç —Å–æ Student Agent'
        },
        {
          key: `hanna_user_${studentId}`,
          title: 'TutorBot Chat', 
          description: '–ß–∞—Ç —Å –æ—Å–Ω–æ–≤–Ω—ã–º –∞–≥–µ–Ω—Ç–æ–º (TutorBot)'
        }
      ];
    }

    async function getLeadsByStatus(status) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ª–∏–¥–æ–≤
      const mockLeads = [
        { id: '937619983', name: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞', status: 'new' },
        { id: '123456789', name: '–ò–≤–∞–Ω –°–∏–¥–æ—Ä–æ–≤', status: 'contacted' },
        { id: '987654321', name: '–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞', status: 'interested' }
      ];
      
      let filteredLeads = mockLeads;
      if (status !== 'all') {
        filteredLeads = mockLeads.filter(lead => lead.status === status);
      }
      
      return filteredLeads.map(lead => ({
        key: `lead_${lead.id}`,
        title: lead.name,
        description: `Telegram ID: ${lead.id}, –°—Ç–∞—Ç—É—Å: ${lead.status}`
      }));
    }

    function showFiltersAndStats() {
      document.getElementById('filterControls').style.display = 'flex';
      document.getElementById('stats').style.display = 'flex';
    }

    function showMemoryKeyInfo(memoryKey) {
      const [agentType, telegramId] = memoryKey.split('_');
      const agentNames = {
        'hanna_user': 'ü§ñ TutorBot (–æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç)',
        'student': 'üë§ Student Agent', 
        'lead': 'üåü Lead Agent'
      };
      
      const agentName = agentNames[agentType] || '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≥–µ–Ω—Ç';
      
      const existingInfo = document.querySelector('.memory-key-info');
      if (existingInfo) existingInfo.remove();
      
      const memoryKeyInfo = document.createElement('div');
      memoryKeyInfo.className = 'memory-key-info';
      memoryKeyInfo.innerHTML = `
        <span><strong>–ö–ª—é—á –ø–∞–º—è—Ç–∏:</strong> <code style="background: var(--bg-color); padding: 2px 6px; border-radius: 4px; font-family: monospace;">${memoryKey}</code></span>
        <span><strong>–ê–≥–µ–Ω—Ç:</strong> ${agentName}</span>
        <span><strong>Telegram ID:</strong> ${telegramId || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
      `;
      
      const filterControls = document.getElementById('filterControls');
      filterControls.parentNode.insertBefore(memoryKeyInfo, filterControls);
    }

    function resetChatInterface() {
      selectedChatKey = null;
      allMessages = [];
      
      document.getElementById('chatList').style.display = 'none';
      document.getElementById('filterControls').style.display = 'none';
      document.getElementById('stats').style.display = 'none';
      document.getElementById('loadChatBtn').disabled = true;
      
      const existingInfo = document.querySelector('.memory-key-info');
      if (existingInfo) existingInfo.remove();
      
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = `
        <div class="loading">
          <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
            <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã:</strong><br>
            ‚Ä¢ ü§ñ TutorBot - –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
            ‚Ä¢ üë§ Student Agent - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤<br>
            ‚Ä¢ üåü Lead Agent - –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
          </div>
        </div>
      `;
    }

    // –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    async function getMockChatData(memoryKey) {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const [agentType, telegramId] = memoryKey.split('_');
      
      if (memoryKey === 'student_71272569') {
        return [
          {
            id: 33,
            session_id: "student_71272569",
            message: JSON.stringify({
              type: "human",
              content: "–ü—Ä–∏–≤–µ—Ç! –ú–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ 'ringard' –≤ –º–æ–π —Å–ª–æ–≤–∞—Ä—å?",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 34,
            session_id: "student_71272569", 
            message: JSON.stringify({
              type: "ai",
              content: "–ì–æ—Ç–æ–≤–æ, –ö—Ä–∏—Å ‚Äî —è –¥–æ–±–∞–≤–∏–ª–∞ —Å–ª–æ–≤–æ ringard / ringarde –≤ —Ç–≤–æ–π —Å–ª–æ–≤–∞—Ä—å. \n\n–í–æ—Ç —á—Ç–æ —è —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞:\n- ringard / ringarde ‚Äî —Ñ—Ä–∞–Ω—Ü. (—Ä–∞–∑–≥.)\n- –ó–Ω–∞—á–µ–Ω–∏–µ: —Å—Ç–∞—Ä–æ–º–æ–¥–Ω—ã–π, –Ω–µ–º–æ–¥–Ω—ã–π, –±–µ–∑–≤–∫—É—Å–Ω—ã–π; ¬´–Ω–µ–∫—Ä—É—Ç–æ–π¬ª\n- –ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ: [ Å…õÃÉ…°a Å] (–ø—Ä–∏–º–µ—Ä–Ω–æ ¬´—Ä—ç–Ω-–≥–∞—Ä¬ª), ringarde ‚Äî [ Å…õÃÉ…°a Åd]\n- –°–∏–Ω–æ–Ω–∏–º—ã: d√©mod√©, d√©pass√©, vieillot, kitsch\n- –ü—Ä–∏–º–µ—Ä—ã: Ce pull est un peu ringard. / Ne sois pas ringard ! / Il fait des blagues ringardes.\n- session_id –Ω–µ —É–∫–∞–∑–∞–Ω\n\n–•–æ—á–µ—à—å, —è —Å–æ—Å—Ç–∞–≤–ª—é –ø–∞—Ä—É –∫–æ—Ä–æ—Ç–∫–∏—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π/–¥–∏–∞–ª–æ–≥–æ–≤ —Å —ç—Ç–∏–º —Å–ª–æ–≤–æ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—é –µ—â—ë 2-3 –ø–æ—Ö–æ–∂–∏—Ö —Å–ª–æ–≤–∞ –≤ —Å–ª–æ–≤–∞—Ä—å?",
              tool_calls: [],
              additional_kwargs: {},
              response_metadata: {},
              invalid_tool_calls: []
            })
          }
        ];
      }
      
      if (memoryKey === 'hanna_user_71272569' || agentType === 'hanna_user') {
        return [
          {
            id: 1,
            session_id: memoryKey,
            message: JSON.stringify({
              type: "system",
              content: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TutorBot –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + telegramId,
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 2,
            session_id: memoryKey,
            message: JSON.stringify({
              type: "human",
              content: "–ü—Ä–∏–≤–µ—Ç –•–∞–Ω–Ω–∞! –ö–∞–∫ –¥–µ–ª–∞?",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 3,
            session_id: memoryKey, 
            message: JSON.stringify({
              type: "ai",
              content: "–ü—Ä–∏–≤–µ—Ç! –£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å —Å –∏–∑—É—á–µ–Ω–∏–µ–º —è–∑—ã–∫–æ–≤. –£ —Ç–µ–±—è –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–º—É –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É?",
              tool_calls: [],
              additional_kwargs: {},
              response_metadata: {}
            })
          }
        ];
      }
      
      if (agentType === 'lead') {
        return [
          {
            id: 1,
            session_id: memoryKey,
            message: JSON.stringify({
              type: "system",
              content: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Lead Agent –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ " + telegramId,
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 2,
            session_id: memoryKey,
            message: JSON.stringify({
              type: "human",
              content: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É —É–∑–Ω–∞—Ç—å –ø—Ä–æ —É—Ä–æ–∫–∏ —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ",
              additional_kwargs: {},
              response_metadata: {}
            })
          },
          {
            id: 3,
            session_id: memoryKey,
            message: JSON.stringify({
              type: "ai",
              content: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –†–∞–¥–∞, —á—Ç–æ –≤—ã –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏—Å—å –∏–∑—É—á–µ–Ω–∏–µ–º —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ! –•–∞–Ω–Ω–∞ - —Å–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å CELTA Grade A —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º.\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ:\n- –ö–∞–∫–æ–π —É –≤–∞—Å —É—Ä–æ–≤–µ–Ω—å —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ —Å–µ–π—á–∞—Å?\n- –ö–∞–∫–∏–µ —Ü–µ–ª–∏ —Ö–æ—Ç–∏—Ç–µ –¥–æ—Å—Ç–∏—á—å?\n- –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –≥–æ—Ç–æ–≤—ã —É–¥–µ–ª—è—Ç—å –∑–∞–Ω—è—Ç–∏—è–º –≤ –Ω–µ–¥–µ–ª—é?\n\n–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –º–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –æ–±—É—á–µ–Ω–∏—è!",
              tool_calls: [],
              additional_kwargs: {},
              response_metadata: {}
            })
          }
        ];
      }
      
      // –î–ª—è –¥—Ä—É–≥–∏—Ö –∫–ª—é—á–µ–π –ø–∞–º—è—Ç–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      return [
        {
          id: 1,
          session_id: memoryKey,
          message: JSON.stringify({
            type: "system",
            content: `–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ —Å –∫–ª—é—á–æ–º –ø–∞–º—è—Ç–∏: ${memoryKey}`,
            additional_kwargs: {},
            response_metadata: {}
          })
        },
        {
          id: 2, 
          session_id: memoryKey,
          message: JSON.stringify({
            type: "ai",
            content: `–ü—Ä–∏–≤–µ—Ç! –Ø ${agentType === 'hanna_user' ? 'TutorBot' : agentType === 'student' ? 'Student Agent' : agentType === 'lead' ? 'Lead Agent' : '–∞–≥–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã'}. Telegram ID: ${telegramId}`,
            tool_calls: [],
            additional_kwargs: {},
            response_metadata: {}
          })
        }
      ];
    }

    function renderMessages() {
      const container = document.getElementById('chatContainer');
      
      const filteredMessages = currentFilter === 'all' 
        ? allMessages 
        : allMessages.filter(msg => {
            try {
              const parsed = JSON.parse(msg.message);
              return parsed.type === currentFilter;
            } catch {
              return false;
            }
          });

      if (filteredMessages.length === 0) {
        container.innerHTML = '<div class="loading">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
        return;
      }

      container.innerHTML = filteredMessages.map(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          const timestamp = new Date().toLocaleString('ru-RU');
          
          return `
            <div class="message ${parsed.type}">
              <div class="message-header">
                <span class="message-type">${getTypeEmoji(parsed.type)} ${parsed.type}</span>
                <span>ID: ${msg.id} | ${timestamp}</span>
              </div>
              <div class="message-content">${escapeHtml(parsed.content)}</div>
              ${parsed.tool_calls && parsed.tool_calls.length > 0 ? `
                <div class="tool-calls">
                  <strong>Tool calls:</strong> ${JSON.stringify(parsed.tool_calls, null, 2)}
                </div>
              ` : ''}
              ${parsed.invalid_tool_calls && parsed.invalid_tool_calls.length > 0 ? `
                <div class="tool-calls">
                  <strong>Invalid tool calls:</strong> ${JSON.stringify(parsed.invalid_tool_calls, null, 2)}
                </div>
              ` : ''}
            </div>
          `;
        } catch (error) {
          return `
            <div class="message system">
              <div class="message-header">
                <span class="message-type">‚ö†Ô∏è ERROR</span>
                <span>ID: ${msg.id}</span>
              </div>
              <div class="message-content">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${escapeHtml(msg.message)}</div>
            </div>
          `;
        }
      }).join('');
    }

    function filterMessages(type) {
      currentFilter = type;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderMessages();
      updateStats();
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const typeCounts = { ai: 0, human: 0, system: 0, error: 0 };
      
      allMessages.forEach(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          typeCounts[parsed.type] = (typeCounts[parsed.type] || 0) + 1;
        } catch {
          typeCounts.error++;
        }
      });
      
      stats.innerHTML = `
        <span>–í—Å–µ–≥–æ: ${allMessages.length}</span>
        <span>AI: ${typeCounts.ai}</span>
        <span>Human: ${typeCounts.human}</span>
        <span>System: ${typeCounts.system}</span>
        ${typeCounts.error > 0 ? `<span>–û—à–∏–±–∫–∏: ${typeCounts.error}</span>` : ''}
      `;
    }

    function getTypeEmoji(type) {
      const emojis = {
        ai: 'ü§ñ',
        human: 'üë§', 
        system: '‚öôÔ∏è',
        assistant: 'ü§ñ',
        user: 'üë§'
      };
      return emojis[type] || '‚ùì';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
