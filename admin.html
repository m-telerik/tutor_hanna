<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å ‚Äî Mini App</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- –¢–≤–æ—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ Mini App) -->
  <script src="js/auth.js"></script>

  <!-- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/admin.css">

  <style>
    :root{
      --bg-color:#0f0f10; --text-color:#fff; --hint-color:#aaa; --link-color:#5ea4ff;
      --button-color:#2ea6ff; --button-text-color:#fff;
      --card-bg:rgba(255,255,255,.04); --border-color:rgba(255,255,255,.08);
      --success-color:#22c55e; --error-color:#ef4444; --accent-color:#3b82f6;
      --font-size-xs:12px; --font-size-sm:13px; --font-size-md:14px; --font-size-lg:15px;
      --radius:12px; --gap:10px;
    }
    html,body{background:var(--bg-color);color:var(--text-color);margin:0;
      padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; font-size:var(--font-size-md);}
    a{color:var(--link-color);text-decoration:none}
    .container{max-width:880px;margin:0 auto;padding:8px 10px 20px;}
    .hidden{display:none!important;}

    .admin-header{display:flex;align-items:center;justify-content:space-between;gap:var(--gap);margin:4px 0 10px;}
    .admin-header h1{font-size:16px;margin:0;font-weight:700;display:flex;gap:6px;align-items:center;}
    .emoji{font-size:16px}
    .user-info{opacity:.85;font-size:var(--font-size-sm);}

    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap);margin:6px 0 10px;}
    @media (max-width:540px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
    .stat-card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:var(--radius);padding:10px;}
    .stat-number{font-size:18px;font-weight:700}
    .stat-label{font-size:var(--font-size-xs);opacity:.8}

    .quick-tools{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);margin:6px 0 12px;}
    @media (max-width:540px){.quick-tools{grid-template-columns:1fr 1fr}}
    .tool-card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:var(--radius);padding:10px;display:flex;gap:8px;align-items:center;min-height:56px;}
    .tool-card .title{font-weight:600;font-size:var(--font-size-sm)}
    .tool-card .subtitle{font-size:var(--font-size-xs);opacity:.8}

    .students-section{margin-top:6px;background:var(--card-bg);border:1px solid var(--border-color);border-radius:var(--radius);padding:10px;}
    .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .section-title{margin:0;font-size:15px;display:flex;gap:6px;align-items:center;}
    .refresh-btn{border:1px solid var(--border-color);background:transparent;color:var(--text-color);padding:6px 10px;border-radius:10px;font-size:var(--font-size-sm);}

    .table-container{overflow:auto;border-radius:10px;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:8px;border-bottom:1px solid var(--border-color);text-align:left;font-size:var(--font-size-sm);}
    th{opacity:.9;font-weight:600;background:rgba(255,255,255,.02);position:sticky;top:0;}

    .student-name a{font-weight:600}
    .student-email{font-size:var(--font-size-xs);opacity:.8}
    .telegram-column{white-space:nowrap}

    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:var(--font-size-xs)}
    .badge-primary{background:rgba(94,164,255,.2);color:#cfe3ff;border:1px solid rgba(94,164,255,.35)}

    .booking-mode .booking-badge{font-size:var(--font-size-xs);padding:2px 6px;border-radius:6px;border:1px solid var(--border-color)}
    .booking-badge.student{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.36)}
    .booking-badge.teacher{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.36)}

    .action-buttons{display:flex;gap:6px}
    .action-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;background:rgba(255,255,255,.06);border:1px solid var(--border-color);font-size:16px;}

    .loading{display:flex;gap:8px;align-items:center;padding:12px;font-size:var(--font-size-sm);opacity:.85}
    .loading-spinner{width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:rgba(255,255,255,.8);animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:16px;opacity:.8}
    .error{padding:12px;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.32);border-radius:10px;color:#fecaca}
  </style>
</head>
<body>
  <div class="container">
    <div id="adminPanel" class="hidden">
      <div class="admin-header">
        <h1><span class="emoji">üëë</span>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1>
        <div class="user-info" id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>

      <div class="stats-grid hidden" id="statsGrid">
        <div class="stat-card"><div class="stat-number" id="totalStudents">0</div><div class="stat-label">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div></div>
        <div class="stat-card"><div class="stat-number" id="upcomingLessons">0</div><div class="stat-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–Ω—è—Ç–∏–π</div></div>
        <div class="stat-card"><div class="stat-number" id="totalWords">‚Äî</div><div class="stat-label">–°–ª–æ–≤ –≤ —Å–ª–æ–≤–∞—Ä—è—Ö</div></div>
        <div class="stat-card"><div class="stat-number" id="weeklyLessons">0</div><div class="stat-label">–ó–∞–Ω—è—Ç–∏–π –≤ –Ω–µ–¥–µ–ª—é</div></div>
      </div>

      <div class="quick-tools">
        <a href="chat-history.html" class="tool-card">
          <span class="emoji">üí¨</span>
          <div>
            <div class="title">–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</div>
            <div class="subtitle">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∏–∞–ª–æ–≥–æ–≤ —Å –∞–≥–µ–Ω—Ç–∞–º–∏</div>
          </div>
        </a>
        <button class="tool-card" onclick="exportData()" style="text-align:left;border:none;">
          <span class="emoji">üìä</span>
          <div>
            <div class="title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            <div class="subtitle">–í—ã–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—É–¥–µ–Ω—Ç–∞—Ö</div>
          </div>
        </button>
        <a href="settings.html" class="tool-card">
          <span class="emoji">‚öôÔ∏è</span>
          <div>
            <div class="title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="subtitle">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∏–Ω–∏-–∞–ø–ø–∞</div>
          </div>
        </a>
      </div>

      <div class="students-section">
        <div class="section-header">
          <h2 class="section-title"><span class="emoji">üßë‚Äçüéì</span>–°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h2>
          <button class="refresh-btn" onclick="loadStudents()"><span class="emoji">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="table-container">
          <div id="studentsContent">
            <div class="loading"><span class="loading-spinner"></span>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤‚Ä¶</div>
          </div>
        </div>
      </div>
    </div>

    <div id="guard" class="error hidden" style="margin:10px;">
      <strong>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.</strong>
      <div style="margin-top:6px; font-size: var(--font-size-sm); opacity:.9;">
        –≠—Ç–æ—Ç —ç–∫—Ä–∞–Ω –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
      </div>
    </div>
  </div>

  <script>
    // ===== Mini App + Auth =====
    const tg = window.Telegram?.WebApp;
    let auth = null;
    let studentsData = [];

    function applyThemeFromTelegram(){
      if(!tg || !tg.themeParams) return;
      const th = tg.themeParams;
      const cssVars = {
        '--bg-color': th.bg_color,
        '--text-color': th.text_color,
        '--hint-color': th.hint_color,
        '--link-color': th.link_color,
        '--button-color': th.button_color,
        '--button-text-color': th.button_text_color,
        '--card-bg': th.secondary_bg_color || 'rgba(255,255,255,.04)',
        '--border-color': 'rgba(255,255,255,.08)',
      };
      Object.entries(cssVars).forEach(([k,v])=>{ if(v) document.documentElement.style.setProperty(k,v); });
      if (tg.platform === 'ios' || tg.platform === 'android'){
        document.documentElement.style.setProperty('--font-size-md','13px');
        document.documentElement.style.setProperty('--font-size-sm','12px');
        document.documentElement.style.setProperty('--font-size-xs','11px');
      }
    }

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    document.addEventListener('DOMContentLoaded', async () => {
      if(!tg){
        const guard = document.getElementById('guard');
        guard.innerHTML = '<strong>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ Telegram.</strong>';
        show(guard); return;
      }

      tg.ready(); tg.expand();
      applyThemeFromTelegram();
      Telegram.WebApp.onEvent('themeChanged', applyThemeFromTelegram);

      tg.BackButton.show();
      tg.BackButton.onClick(() => tg.close());

      // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ (—á–µ—Ä–µ–∑ /api/user-role –∏ x-telegram-id)
      try{
        auth = new AuthSystem();
        const user = await auth.init(['admin'], onAuthSuccess, onAuthFail);
        // onAuthSuccess –≤—ã–∑–æ–≤–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏, –Ω–æ –≤–µ—Ä–Ω—É–≤—à–∏–π—Å—è user –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      }catch(e){
        // –û—à–∏–±–∫–∞ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–∞ —á–µ—Ä–µ–∑ auth.showAuthError
      }
    });

    function onAuthSuccess(user){
      // –≤–µ—Ä—Ö–Ω—è—è –ø–ª–∞—à–∫–∞
      const u = tg?.initDataUnsafe?.user || {};
      document.getElementById('userInfo').textContent =
        `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${u.first_name || ''} ${u.last_name || ''} (@${u.username || '‚Äî'})`;
      show(document.getElementById('adminPanel'));
      loadStudents();
    }
    function onAuthFail(_error){
      show(document.getElementById('guard'));
    }

    // ===== Data =====
    async function loadStudents(){
      const box = document.getElementById('studentsContent');
      box.innerHTML = `<div class="loading"><span class="loading-spinner"></span>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤‚Ä¶</div>`;

      try{
        const res = await auth.apiRequest('/api/students', { method:'GET' });
        if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const data = await res.json();
        if(!data.students) throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç API: –Ω–µ—Ç –ø–æ–ª—è students');
        studentsData = data.students;
        renderStudentsTable(studentsData);
        updateStats(studentsData);
      }catch(err){
        box.innerHTML = `<div class="error"><strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</strong><div style="margin-top:6px;">${err.message}</div></div>`;
      }
    }

    function getBookingModeDisplay(bookingMode, preferredTime, preferredDays){
      if(bookingMode === 'by_student'){
        return `<div class="booking-mode"><span class="booking-badge student">üßë‚Äçüéì –°—Ç—É–¥–µ–Ω—Ç</span></div>`;
      }else{
        const timeInfo = preferredTime ? `‚è∞ ${preferredTime}` : '';
        const daysInfo = (preferredDays && preferredDays.length) ? `üìÖ ${preferredDays.join(', ')}` : '';
        return `<div class="booking-mode">
          <span class="booking-badge teacher">üë©‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</span>
          <small style="opacity:.7;display:block;margin-top:2px;">${daysInfo} ${timeInfo}</small>
        </div>`;
      }
    }

    function renderStudentsTable(students){
      const box = document.getElementById('studentsContent');
      if(!students.length){
        box.innerHTML = `<div class="empty-state"><div class="emoji" style="font-size:28px;">üë•</div><div style="margin-top:6px;">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div></div>`;
        return;
      }

      box.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>–°—Ç—É–¥–µ–Ω—Ç</th>
              <th>Telegram</th>
              <th>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</th>
              <th>–Ø–∑—ã–∫</th>
              <th>–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            ${students.map(s => `
              <tr>
                <td>
                  <div class="student-name">
                    <a href="student.html?user_id=${encodeURIComponent(s.id || s.user_id || '')}">
                      ${s.name || '‚Äî'}
                    </a>
                  </div>
                  ${s.email ? `<div class="student-email">${s.email}</div>` : ''}
                </td>
                <td class="telegram-column">
                  ${s.username ? `<a href="https://t.me/${s.username}" target="_blank">@${s.username}</a>` : '<span style="opacity:.6;">‚Äî</span>'}
                  ${s.telegram_id ? `<br><small>ID: ${s.telegram_id}</small>` : ''}
                </td>
                <td>${getBookingModeDisplay(s.booking_mode, s.preferred_time, s.preferred_days)}</td>
                <td><span class="badge badge-primary">${s.language || '‚Äî'}</span>
                  ${s.frequency ? `<br><small style="opacity:.7;">${s.frequency}√ó –≤ –Ω–µ–¥–µ–ª—é</small>` : ''}</td>
                <td>
                  ${s.next_session
                    ? `<a href="lesson.html?session_id=${encodeURIComponent(s.next_session_id || '')}">${s.next_session}</a>`
                    : '<span style="opacity:.6;">–ù–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>'}
                </td>
                <td>
                  <div class="action-buttons">
                    <a href="student.html?user_id=${encodeURIComponent(s.id || s.user_id || '')}" class="action-btn" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§</a>
                    <a href="vocabulary.html?user_id=${encodeURIComponent(s.id || s.user_id || '')}" class="action-btn" title="–°–ª–æ–≤–∞—Ä—å">üìö</a>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function updateStats(students){
      const total = students.length;
      const upcoming = students.filter(s => s.next_session).length;
      const weekly = students.reduce((sum,s)=> sum + (s.frequency || 0), 0);

      const totalEl = document.getElementById('totalStudents');
      const upEl = document.getElementById('upcomingLessons');
      const wordsEl = document.getElementById('totalWords');
      const weeklyEl = document.getElementById('weeklyLessons');
      const grid = document.getElementById('statsGrid');

      if(totalEl) totalEl.textContent = total;
      if(upEl) upEl.textContent = upcoming;
      if(wordsEl) wordsEl.textContent = '‚Äî';
      if(weeklyEl) weeklyEl.textContent = weekly;
      if(grid) grid.classList.remove('hidden');
    }

    async function exportData(){
      if(!auth || !auth.isAuth() || !studentsData.length){ return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞'); }
      try{
        const user = auth.getCurrentUser();
        const payload = {
          students: studentsData,
          exportDate: new Date().toISOString(),
          exportedBy: user?.username || user?.first_name || 'admin',
          totalStudents: studentsData.length,
          upcomingLessons: studentsData.filter(s => s.next_session).length
        };
        const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `hanna_students_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }catch(e){ alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message); }
    }
  </script>
</body>
</html>
