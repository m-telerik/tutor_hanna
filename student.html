<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/student.css">
</head>
<body>
  <div class="page-content">
    <div class="header">
      <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
      <h1><span class="emoji">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞</h1>
      <div></div>
    </div>

    <div class="student-info" id="student-info">
      <div class="loading">
        <span class="loading-spinner"></span>
        –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—É–¥–µ–Ω—Ç–µ...
      </div>
    </div>

    <div class="quick-actions" id="quick-actions" style="display: none;">
      <a href="#" class="action-card" id="vocab-link">
        <span class="emoji">üìö</span>
        <div class="title">–°–ª–æ–≤–∞—Ä—å</div>
        <div class="subtitle">–í—Å–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞</div>
      </a>
      
      <a href="#" class="action-card" id="next-lesson-link" style="display: none;">
        <span class="emoji">üìÖ</span>
        <div class="title">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫</div>
        <div class="subtitle">–ü–µ—Ä–µ–π—Ç–∏ –∫ —É—Ä–æ–∫—É</div>
      </a>

      <a href="https://t.me/hanna_teaches" class="action-card" target="_blank">
        <span class="emoji">üí¨</span>
        <div class="title">–ù–∞–ø–∏—Å–∞—Ç—å –•–∞–Ω–Ω–µ</div>
        <div class="subtitle">–û–±—Å—É–¥–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã</div>
      </a>
    </div>

    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="contact-info" id="contact-info" style="display: none;">
      <h3><span class="emoji">üìû</span>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
      <p>
        –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã? –ù–∞–ø–∏—à–∏—Ç–µ –•–∞–Ω–Ω–µ –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram: 
        <a href="https://t.me/hanna_teaches" target="_blank" style="color: var(--accent-color);">@hanna_teaches</a>
      </p>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const studentName = urlParams.get("name");
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å userId –∏–∑ Telegram WebApp, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π
    let userId = null;
    
    try {
      userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    } catch (error) {
      console.log('Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
    }
    
    // –ï—Å–ª–∏ –Ω–µ—Ç userId –∏–∑ Telegram, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π ID –∞–¥–º–∏–Ω–∞
    if (!userId) {
      userId = 618647337; // –¢–µ—Å—Ç–æ–≤—ã–π ID –∞–¥–º–∏–Ω–∞
      console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π userId:', userId);
    }
    
    const studentInfoDiv = document.getElementById("student-info");
    const quickActions = document.getElementById("quick-actions");
    const vocabLink = document.getElementById("vocab-link");
    const nextLessonLink = document.getElementById("next-lesson-link");
    const contactInfo = document.getElementById("contact-info");

    if (!studentName) {
      studentInfoDiv.innerHTML = `
        <div class="error">
          <h3>–û—à–∏–±–∫–∞</h3>
          <p>–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ URL</p>
          <button onclick="history.back()" class="btn-primary">–ù–∞–∑–∞–¥</button>
        </div>
      `;
    } else {
      loadStudentInfo();
    }

    async function loadStudentInfo() {
      try {
        console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—É–¥–µ–Ω—Ç–µ:', studentName);
        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º userId:', userId);
        
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId.toString() }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const { students } = await response.json();
        const student = students.find(s => s.name === studentName);

        if (!student) {
          studentInfoDiv.innerHTML = `
            <div class="error">
              <h3>–°—Ç—É–¥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</h3>
              <p>–°—Ç—É–¥–µ–Ω—Ç "${studentName}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ</p>
              <button onclick="history.back()" class="btn-primary">–ù–∞–∑–∞–¥</button>
            </div>
          `;
          return;
        }

        console.log('–°—Ç—É–¥–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω:', student);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.title = `–ü—Ä–æ—Ñ–∏–ª—å: ${student.name}`;
        document.querySelector('h1').innerHTML = `<span class="emoji">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å: ${student.name}`;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        const bookingModeText = student.booking_mode === 'by_student' 
          ? 'üìÖ –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' 
          : 'üéì –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–Ω—è—Ç–∏—è';

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        studentInfoDiv.innerHTML = `
          <div class="student-header">
            <h2><span class="emoji">üëã</span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ</h2>
          </div>
          
          <div class="info-grid">
            <div class="info-item">
              <strong><span class="emoji">üë§</span>–ò–º—è:</strong> 
              <span>${student.name}</span>
            </div>
            
            ${student.username ? `
              <div class="info-item">
                <strong><span class="emoji">üí¨</span>Telegram:</strong> 
                <a href="https://t.me/${student.username}" target="_blank" style="color: var(--accent-color);">
                  @${student.username}
                </a>
              </div>
            ` : ''}
            
            ${student.email ? `
              <div class="info-item">
                <strong><span class="emoji">üìß</span>Email:</strong> 
                <span>${student.email}</span>
              </div>
            ` : ''}
            
            <div class="info-item">
              <strong><span class="emoji">üåç</span>–Ø–∑—ã–∫:</strong> 
              <span class="language-badge">${student.language || '‚Äî'}</span>
            </div>
            
            ${student.frequency ? `
              <div class="info-item">
                <strong><span class="emoji">üìÖ</span>–ß–∞—Å—Ç–æ—Ç–∞:</strong> 
                <span>${student.frequency} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é</span>
              </div>
            ` : ''}
            
            <div class="info-item">
              <strong><span class="emoji">‚öôÔ∏è</span>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> 
              <span>${bookingModeText}</span>
            </div>
            
            ${student.preferred_time ? `
              <div class="info-item">
                <strong><span class="emoji">üïê</span>–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–æ–µ –≤—Ä–µ–º—è:</strong> 
                <span>${student.preferred_time}</span>
              </div>
            ` : ''}
            
            ${student.preferred_days && student.preferred_days.length > 0 ? `
              <div class="info-item">
                <strong><span class="emoji">üìÜ</span>–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–µ –¥–Ω–∏:</strong> 
                <span>${student.preferred_days.join(', ')}</span>
              </div>
            ` : ''}
          </div>

          ${student.next_session ? `
            <div class="next-lesson-card">
              <h3><span class="emoji">üìÖ</span>–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ</h3>
              <div class="lesson-details">
                <span class="lesson-date">${student.next_session}</span>
                <a href="lesson.html?session_id=${student.next_session_id}" class="lesson-link">
                  –ü–µ—Ä–µ–π—Ç–∏ –∫ —É—Ä–æ–∫—É ‚Üí
                </a>
              </div>
            </div>
          ` : `
            <div class="next-lesson-card no-lesson">
              <h3><span class="emoji">üìÖ</span>–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ</h3>
              <p>–ó–∞–Ω—è—Ç–∏–µ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</p>
              ${student.booking_mode === 'by_student' ? `
                <a href="https://calendar.app.google/SQGJj626MUyQ6DYL6" target="_blank" class="btn-primary">
                  <span class="emoji">üìÖ</span>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ
                </a>
              ` : `
                <p style="font-size: 12px; opacity: 0.7;">
                  –ó–∞–Ω—è—Ç–∏—è –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å
                </p>
              `}
            </div>
          `}
        `;

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        vocabLink.href = `vocabulary.html?student_name=${encodeURIComponent(student.name)}`;
        
        if (student.next_session_id) {
          nextLessonLink.href = `lesson.html?session_id=${student.next_session_id}`;
          nextLessonLink.style.display = 'block';
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        quickActions.style.display = 'grid';
        contactInfo.style.display = 'block';

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—É–¥–µ–Ω—Ç–µ:', error);
        studentInfoDiv.innerHTML = `
          <div class="error">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—É–¥–µ–Ω—Ç–µ: ${error.message}</p>
            <button onclick="loadStudentInfo()" class="btn-primary">
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
            <button onclick="history.back()" class="btn-secondary" style="margin-left: 10px;">
              –ù–∞–∑–∞–¥
            </button>
          </div>
        `;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    if (window.Telegram?.WebApp) {
      try {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      } catch (error) {
        console.log('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
      }
    }

    console.log('Student page –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–ª—è:', studentName);
  </script>

  <style>
    .info-grid {
      display: grid;
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      background: var(--bg-color);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .info-item strong {
      color: var(--text-color);
      font-weight: 600;
      min-width: 180px;
    }
    
    .language-badge {
      background: var(--accent-color);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .next-lesson-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      border: 1px solid var(--border-color);
    }
    
    .next-lesson-card.no-lesson {
      text-align: center;
      opacity: 0.8;
    }
    
    .lesson-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
    }
    
    .lesson-date {
      font-weight: 600;
      color: var(--success-color);
    }
    
    .lesson-link {
      background: var(--success-color);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      transition: opacity 0.2s;
    }
    
    .lesson-link:hover {
      opacity: 0.9;
      text-decoration: none;
    }
    
    @media (max-width: 768px) {
      .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .info-item strong {
        min-width: auto;
      }
      
      .lesson-details {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
    }
  </style>
</body>
</html>
