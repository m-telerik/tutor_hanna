<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hanna English & French</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="js/auth.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    :root{--accent-color:#3b82f6;--text-color:#e5e7eb;--bg-color:#0f1115;}
    html,body{margin:0;background:var(--bg-color);color:var(--text-color);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;text-align:center}
    .spinner{width:50px;height:50px;border:3px solid var(--accent-color);border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    h1{margin:0 0 8px;font-size:18px;color:var(--accent-color)}
    p{margin:0;opacity:.8}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn{margin-top:18px;display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent-color);color:#fff;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap" id="loadingScreen">
    <div>
      <div class="spinner"></div>
      <h1>Hanna English & French</h1>
      <p id="loadingText">Определяем вашу роль…</p>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    function goBooking(){ window.location.replace('booking.html'); }

    function showOpenInTelegram(){
      const box = document.getElementById('loadingScreen');
      box.innerHTML = `
        <div>
          <h1>Откройте мини‑приложение в Telegram</h1>
          <p>Эта страница работает только внутри Telegram WebApp.</p>
          <a class="btn" href="https://t.me/tutor_hanna_bot">Открыть бота</a>
        </div>
      `;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (!tg || !tg.initDataUnsafe?.user) {
          showOpenInTelegram();
          return;
        }

        tg.ready(); tg.expand();

        // Вариант №1: разрешаем 'prospect', чтобы попасть в onAuthSuccess и там решить редирект
        const auth = new AuthSystem();
        await auth.init(['admin','tutor','student','prospect'], onAuthSuccess, onAuthFail);

        // Фолбэк от вечной загрузки (если вдруг колбэки не сработали)
        setTimeout(() => {
          const txt = document.getElementById('loadingText')?.textContent || '';
          if (txt.includes('Определяем вашу роль')) goBooking();
        }, 7000);

      } catch (e) {
        goBooking();
      }
    });

    function onAuthSuccess(user){
      try {
        switch (user.role) {
          case 'admin':   return window.location.replace('admin.html');
          case 'tutor':   return window.location.replace('tutor.html');
          case 'student': {
            const id = encodeURIComponent(user.user_id || user.id || '');
            return id ? window.location.replace(`student.html?user_id=${id}`) : goBooking();
          }
          // Все «новые»/неизвестные роли — на бронирование
          case 'prospect':
          default:        return goBooking();
        }
      } catch { goBooking(); }
    }

    function onAuthFail(_error){
      // Любая ошибка авторизации — бронирование
      goBooking();
    }
  </script>
</body>
</html>
