<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/chat-history.css">
</head>
<body>
  <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="header">
    <h1><span class="emoji">üí¨</span>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h1>
    
    <div class="navigation-panel">
      <!-- –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id -->
      <div class="step">
        <div class="step-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</div>
        <div class="step-controls">
          <select id="telegramIdSelect" onchange="onTelegramIdChange()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>
          </select>
          <button class="load-btn" onclick="loadChatData()" disabled id="loadDataBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats" id="stats" style="display: none;"></div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
  <div id="userInfo" style="display: none;"></div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
  <div class="data-table" id="dataTable" style="display: none;">
    <table>
      <thead>
        <tr>
          <th>Session ID</th>
          <th>–¢–∏–ø –∞–≥–µ–Ω—Ç–∞</th>
          <th>–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è</th>
          <th>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</th>
          <th>–í—Ä–µ–º—è</th>
        </tr>
      </thead>
      <tbody id="dataTableBody">
      </tbody>
    </table>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ -->
  <div id="statusContainer">
    <div class="loading">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤</p>
      <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
        <strong>–ß—Ç–æ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:</strong><br>
        ‚Ä¢ üí¨ –í—Å–µ –¥–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≥–µ–Ω—Ç–∞–º–∏<br>
        ‚Ä¢ ü§ñ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç AI –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>
        ‚Ä¢ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–±—â–µ–Ω–∏—é
      </div>
    </div>
  </div>

  <script>
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 618647337;
    let currentTelegramId = '';
    let allMessages = [];
    let availableUsers = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      
      loadAvailableUsers();
    });

    async function loadAvailableUsers() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤
        const response = await fetch('/api/students', {
          headers: { "x-telegram-id": userId }
        });
        
        if (response.ok) {
          const { students } = await response.json();
          availableUsers = students;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
          const adminUsers = [
            { name: '–ê–Ω–Ω–∞ (–∞–¥–º–∏–Ω)', telegram_id: 618647337, username: 'admin1' },
            { name: '–ê–¥–º–∏–Ω 2', telegram_id: 2341205, username: 'admin2' }
          ];
          
          availableUsers = [...adminUsers, ...students];
          populateUserSelect();
        }
      } catch (error) {
        console.error('Error loading users:', error);
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        availableUsers = [
          { name: '–ê–Ω–Ω–∞ (–∞–¥–º–∏–Ω)', telegram_id: 618647337, username: 'admin1' },
          { name: '–ú–∞—Ä–∏–Ω–∞', telegram_id: 2341205, username: 'naumenko' },
          { name: '–ú–∏—Ö–∞–∏–ª', telegram_id: 96911488, username: 'YoroolGui' },
          { name: '–Æ–ª–∏—è', telegram_id: 396796964, username: 'juliia_go' }
        ];
        populateUserSelect();
      }
    }

    function populateUserSelect() {
      const select = document.getElementById('telegramIdSelect');
      
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>';
      
      availableUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.telegram_id;
        option.textContent = `${user.name} (@${user.username || 'no_username'}) - ID: ${user.telegram_id}`;
        select.appendChild(option);
      });
    }

    function onTelegramIdChange() {
      const select = document.getElementById('telegramIdSelect');
      const loadBtn = document.getElementById('loadDataBtn');
      
      currentTelegramId = select.value;
      loadBtn.disabled = !currentTelegramId;
      
      // –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      resetInterface();
    }

    async function loadChatData() {
      const statusContainer = document.getElementById('statusContainer');
      const dataTable = document.getElementById('dataTable');
      const stats = document.getElementById('stats');
      const userInfo = document.getElementById('userInfo');
      
      if (!currentTelegramId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      statusContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤...</div>';
      dataTable.style.display = 'none';
      stats.style.display = 'none';
      userInfo.style.display = 'none';

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API endpoint
        const response = await fetch(`/api/chat-history?telegram_id=${currentTelegramId}`, {
          headers: { "x-telegram-id": userId }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const { messages, user_info } = await response.json();
        
        if (!messages || messages.length === 0) {
          statusContainer.innerHTML = '<div class="loading">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
          return;
        }
        
        allMessages = messages;
        renderDataTable();
        updateStats();
        showUserInfo(user_info || getSelectedUserInfo());
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        statusContainer.style.display = 'none';
        dataTable.style.display = 'block';
        stats.style.display = 'flex';
        userInfo.style.display = 'block';
        
      } catch (error) {
        console.error('Error loading chat data:', error);
        statusContainer.innerHTML = `
          <div class="error">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤: ${error.message}</p>
            <button onclick="loadChatData()" style="margin-top: 1rem; background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    function getSelectedUserInfo() {
      return availableUsers.find(u => u.telegram_id == currentTelegramId) || 
             { name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', telegram_id: currentTelegramId };
    }

    function renderDataTable() {
      const tbody = document.getElementById('dataTableBody');
      
      tbody.innerHTML = allMessages.map(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          const timestamp = msg.created_at ? new Date(msg.created_at).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∞–≥–µ–Ω—Ç–∞ –∏–∑ session_id
          let agentType = 'unknown';
          let agentLabel = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          
          if (msg.session_id.startsWith('hanna_user_')) {
            agentType = 'tutor';
            agentLabel = 'ü§ñ TutorBot';
          } else if (msg.session_id.startsWith('student_')) {
            agentType = 'student';
            agentLabel = 'üë§ Student Agent';
          } else if (msg.session_id.startsWith('lead_')) {
            agentType = 'lead';
            agentLabel = 'üåü Lead Agent';
          } else if (msg.session_id.startsWith('calendar_')) {
            agentType = 'calendar';
            agentLabel = 'üìÖ Calendar Agent';
          }
          
          // –û–±—Ä–µ–∑–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–≤—å—é
          const content = parsed.content || '–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ';
          const contentPreview = content.length > 100 ? content.substring(0, 100) + '...' : content;
          
          return `
            <tr>
              <td>
                <code style="font-size: 10px; background: var(--card-bg); padding: 2px 4px; border-radius: 3px;">
                  ${msg.session_id}
                </code>
              </td>
              <td>
                <span class="agent-badge ${agentType}">${agentLabel}</span>
              </td>
              <td>
                <span class="type-badge ${parsed.type}">${getTypeEmoji(parsed.type)} ${parsed.type}</span>
              </td>
              <td class="content-cell" title="${escapeHtml(content)}">
                ${escapeHtml(contentPreview)}
              </td>
              <td>
                <small>${timestamp}</small>
              </td>
            </tr>
          `;
        } catch (error) {
          return `
            <tr>
              <td colspan="5" class="error">
                –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ID: ${msg.id}
              </td>
            </tr>
          `;
        }
      }).join('');
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const typeCounts = { ai: 0, human: 0, system: 0, error: 0 };
      const agentCounts = { tutor: 0, student: 0, lead: 0, calendar: 0, unknown: 0 };
      
      allMessages.forEach(msg => {
        try {
          const parsed = JSON.parse(msg.message);
          typeCounts[parsed.type] = (typeCounts[parsed.type] || 0) + 1;
          
          // –ü–æ–¥—Å—á–µ—Ç –ø–æ –∞–≥–µ–Ω—Ç–∞–º
          if (msg.session_id.startsWith('hanna_user_')) agentCounts.tutor++;
          else if (msg.session_id.startsWith('student_')) agentCounts.student++;
          else if (msg.session_id.startsWith('lead_')) agentCounts.lead++;
          else if (msg.session_id.startsWith('calendar_')) agentCounts.calendar++;
          else agentCounts.unknown++;
        } catch {
          typeCounts.error++;
        }
      });
      
      stats.innerHTML = `
        <span><strong>–í—Å–µ–≥–æ:</strong> ${allMessages.length}</span>
        <span><strong>AI:</strong> ${typeCounts.ai}</span>
        <span><strong>Human:</strong> ${typeCounts.human}</span>
        <span><strong>System:</strong> ${typeCounts.system}</span>
        <span><strong>TutorBot:</strong> ${agentCounts.tutor}</span>
        <span><strong>Student:</strong> ${agentCounts.student}</span>
        <span><strong>Lead:</strong> ${agentCounts.lead}</span>
        <span><strong>Calendar:</strong> ${agentCounts.calendar}</span>
        ${typeCounts.error > 0 ? `<span style="color: var(--error-color);"><strong>–û—à–∏–±–∫–∏:</strong> ${typeCounts.error}</span>` : ''}
      `;
    }

    function showUserInfo(userInfo) {
      const userInfoDiv = document.getElementById('userInfo');
      
      userInfoDiv.innerHTML = `
        <div class="memory-key-info">
          <span><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${userInfo.name}</span>
          <span><strong>Telegram ID:</strong> ${userInfo.telegram_id}</span>
          <span><strong>Username:</strong> @${userInfo.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
          <span><strong>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong> ${allMessages.length}</span>
        </div>
      `;
    }

    function resetInterface() {
      allMessages = [];
      
      document.getElementById('dataTable').style.display = 'none';
      document.getElementById('stats').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
      
      document.getElementById('statusContainer').innerHTML = `
        <div class="loading">
          <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤</p>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 1rem;">
            <strong>–ß—Ç–æ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:</strong><br>
            ‚Ä¢ üí¨ –í—Å–µ –¥–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≥–µ–Ω—Ç–∞–º–∏<br>
            ‚Ä¢ ü§ñ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç AI –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>
            ‚Ä¢ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–±—â–µ–Ω–∏—é
          </div>
        </div>
      `;
      document.getElementById('statusContainer').style.display = 'block';
    }

    function getTypeEmoji(type) {
      const emojis = {
        ai: 'ü§ñ',
        human: 'üë§', 
        system: '‚öôÔ∏è',
        assistant: 'ü§ñ',
        user: 'üë§'
      };
      return emojis[type] || '‚ùì';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
  
  <style>
    .step {
      margin-bottom: 1rem;
    }
    
    .step-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }
    
    .step-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    #telegramIdSelect {
      flex: 1;
      min-width: 250px;
      padding: 8px 12px;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-color);
    }
    
    .load-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .load-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .load-btn:hover:not(:disabled) {
      opacity: 0.9;
    }
    
    .agent-badge {
      background: var(--accent-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
    }
    
    .agent-badge.tutor {
      background: var(--tutor-accent);
    }
    
    .agent-badge.student {
      background: var(--accent-color);
    }
    
    .agent-badge.lead {
      background: var(--admin-accent);
    }
    
    .agent-badge.calendar {
      background: #17a2b8;
    }
    
    .agent-badge.unknown {
      background: var(--border-color);
      color: var(--text-color);
    }

    @media (max-width: 600px) {
      .step-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      #telegramIdSelect {
        min-width: auto;
        width: 100%;
      }
    }
  </style>
</body>
</html>
