<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/booking.css">
</head>
<body>
  <div id="bookingContent" style="display:none;">
    <div class="header">
      <button onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
      <h1><span class="emoji">üìÖ</span>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
      <div></div>
    </div>

    <div class="welcome-info" id="welcomeInfo" style="display:none;"></div>

    <div class="quick-actions">
      <a href="https://t.me/hanna_teaches" class="action-btn">
        <span class="emoji">üí¨</span>
        <strong>–ù–∞–ø–∏—Å–∞—Ç—å –•–∞–Ω–Ω–µ</strong>
        <small>–û–±—Å—É–¥–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</small>
      </a>
      <div class="action-btn" onclick="openCalendarBooking()">
        <span class="emoji">üìÖ</span>
        <strong>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è</strong>
        <small>–í—ã–±—Ä–∞—Ç—å —Å–ª–æ—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ</small>
      </div>
    </div>

    <div class="calendar-container">
      <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:400px;background:var(--card-bg);border-radius:8px;padding:2rem;text-align:center;">
        <div style="width:50px;height:50px;border:3px solid var(--accent-color);border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:2rem;"></div>
        <h2 style="margin-bottom:1rem;color:var(--accent-color);">–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å...</h2>
        <p style="opacity:.8;margin-bottom:2rem;line-height:1.6;max-width:320px;">
          –°–µ–π—á–∞—Å –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –•–∞–Ω–Ω—ã
        </p>
        <button onclick="openCalendarBooking()" class="external-link-btn" style="font-size:16px;padding:12px 24px;">
          <span class="emoji">üìÖ</span>–û—Ç–∫—Ä—ã—Ç—å –≤—Ä—É—á–Ω—É—é
        </button>
        <p style="font-size:12px;opacity:.6;margin-top:1rem;">–ï—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª</p>
      </div>
    </div>
  </div>

  <script>
    const CALENDAR_BOOKING_URL = 'https://calendar.app.google/SQGJj626MUyQ6DYL6';
    const REDIRECT_KEY = 'booking_redirect_ts';
    const REDIRECT_TTL_MS = 15 * 60 * 1000; // 15 –º–∏–Ω—É—Ç

    function openCalendarBooking() {
      if (window.Telegram?.WebApp?.openLink) {
        window.Telegram.WebApp.openLink(CALENDAR_BOOKING_URL);
      } else {
        window.location.href = CALENDAR_BOOKING_URL;
      }
      // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ñ–∞–∫—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è, —á—Ç–æ–±—ã –Ω–µ –∞–≤—Ç–æ–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
      sessionStorage.setItem(REDIRECT_KEY, Date.now().toString());
    }

    function shouldAutoRedirect(){
      const ts = parseInt(sessionStorage.getItem(REDIRECT_KEY) || '0', 10);
      if (!ts) return true;
      return (Date.now() - ts) > REDIRECT_TTL_MS;
    }

    function personalizeWelcome(user){
      const el = document.getElementById('welcomeInfo');
      const next = user?.next_session?.date ? `
        <div style="margin-top:1rem;padding:.8rem;background:var(--success-color);color:#fff;border-radius:8px;">
          üìÖ –í–∞—à–µ —Å–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ: ${user.next_session.date}
        </div>` : '';
      el.innerHTML = `
        <div style="background:var(--card-bg);border-radius:12px;padding:1.5rem;margin:1rem 0;border:1px solid var(--border-color);text-align:center;">
          <h2 style="margin:0 0 .5rem 0;color:var(--accent-color);">
            üëã –ü—Ä–∏–≤–µ—Ç, ${user?.first_name || user?.name || '—Å—Ç—É–¥–µ–Ω—Ç'}!
          </h2>
          <p style="margin:0;opacity:.8;">${user?.role === 'admin' ? '–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ –¥–ª—è –ª—é–±–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞' : '–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–Ω—è—Ç–∏—è'}</p>
          ${next}
        </div>`;
      el.style.display = 'block';
    }

    async function fetchUserRole(telegramId){
      try {
        const res = await fetch('/api/user-role', { headers: { 'x-telegram-id': telegramId.toString() } });
        if (!res.ok) return null;
        return await res.json(); // –º–æ–∂–µ—Ç –±—ã—Ç—å admin/student/tutor/prospect
      } catch { return null; }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Telegram UI
      if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); }

      document.getElementById('bookingContent').style.display = 'block';

      // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è (–±–µ–∑ —Å—Ç—Ä–æ–≥–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || null;
      if (tgUser?.id) {
        const user = await fetchUserRole(tgUser.id);
        if (user && (user.role === 'admin' || user.role === 'student' || user.role === 'tutor')) {
          personalizeWelcome({ ...user, first_name: tgUser.first_name });
        } else {
          // prospect/unknown ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º: –±–ª–æ–∫ —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π –Ω–∏–∂–µ –æ–±—â–∏–π)
        }
      }

      // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –¥–µ–ª–∞–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ
      if (shouldAutoRedirect()) {
        setTimeout(openCalendarBooking, 900);
      }
    });
  </script>

  <style>
    @keyframes spin { to { transform: rotate(360deg) } }
  </style>
</body>
</html>
